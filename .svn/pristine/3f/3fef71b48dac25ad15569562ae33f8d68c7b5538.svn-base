package kr.or.ddit.controller.notice;

import java.util.List;

import javax.inject.Inject;
import javax.servlet.http.HttpServletRequest;

import org.apache.commons.lang3.StringUtils;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import kr.or.ddit.ServiceResult;
import kr.or.ddit.service.IEmpNoticeService;
import kr.or.ddit.vo.EmpNoticeVO;
import kr.or.ddit.vo.PaginationVO;
import lombok.extern.slf4j.Slf4j;
import oracle.jdbc.proxy.annotation.Post;

@Controller
@RequestMapping("/emp/notice")
@Slf4j
public class EmpNoticeController {
	// 리턴할 때 tiles는 main/ 으로 시작하기
	@Inject
	private IEmpNoticeService noticeService;
	
	// 직원용 공지사항 글쓰기 화면으로 이동
	@GetMapping("/form")
	public String getEmpNoticeForm () {
		log.info("[getEmpNoticeForm] 실행");
		return "empNotice/empNoticeForm";
	}
	
	// 직원용 공지사항 글쓰기 등록 처리
	@PostMapping("/insert.do")
	public String registerEmpNotice (EmpNoticeVO empNoticeVO, Model model) {
		log.info("[registerEmpNotice] 실행");
		String goPage = "";
		log.info("[registerEmpNotice] Fix? " + empNoticeVO.getEmpNoticeFix());
		ServiceResult result = noticeService.postEmpNotice(empNoticeVO);
		
		if(result.equals(ServiceResult.OK)) {
			goPage = "redirect:/emp/notice/detail?empNoticeNo=" + empNoticeVO.getEmpNoticeNo();
		}else {
			goPage = "empNotice/form";
		}
		return goPage;
	}
	
	// 직원용 공지사항 새 글 등록 처리 
	@PostMapping("/create.do")
	public ResponseEntity<EmpNoticeVO> createEmpNoticeDetail (
			@RequestBody EmpNoticeVO empNoticeVO, 
			Model model, RedirectAttributes ra
			){
		log.info("[createEmpNoticeDetail] 새글등록 실행: Fix? " + empNoticeVO.getEmpNoticeFix());
		log.info("[createEmpNoticeDetail] 새글등록 VO: " + empNoticeVO);
		
		ServiceResult result = noticeService.postEmpNotice(empNoticeVO);
		if(result.equals(ServiceResult.OK)) {
			log.info("[createEmpNoticeDetail] 새 글 등록 성공");
			ra.addFlashAttribute("message", "공지사항 등록이 완료되었습니다.");
			return ResponseEntity.ok().body(empNoticeVO);
		}else {
			log.info("[createEmpNoticeDetail] 등록 실패");
			model.addAttribute("empNoticeVO", empNoticeVO);
			model.addAttribute("message", "공지사항 새 글 등록에 실패했습니다. 다시 시도해주세요." );
			return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);
		}
	
	}
	
	// 직원용 공지사항 목록
	@RequestMapping(value = "/list")
	public String getEmpNoticeList (
			@RequestParam(name="page", required = false, defaultValue = "1") int currentPage,
			@RequestParam(required = false, defaultValue = "title") String searchType,
			@RequestParam(required = false) String searchWord,
			Model model
			) {
		log.info("[getEmpNoticeList] 실행");
		PaginationVO<EmpNoticeVO> pagingVO = new PaginationVO<EmpNoticeVO>();
		
//		log.info("[getEmpNoticeList] 검색어가 있는 경우?" 
//				+ searchWord + " | " + searchType);
		// 검색 기능 추가 자리
		if(StringUtils.isNotBlank(searchWord)) {
			log.info("[getEmpNoticeList] 검색어 if절 내부");
			pagingVO.setSearchType(searchType);
			pagingVO.setSearchWord(searchWord);
			
			model.addAttribute("searchType", searchType);
			model.addAttribute("searchWord", searchWord);
		}
		
		pagingVO.setCurrentPage(currentPage);
		int totalRecord = noticeService.getEmpNoticeCount(pagingVO);
		pagingVO.setTotalRecord(totalRecord);
		
		List<EmpNoticeVO> dataList = noticeService.getEmpNoticeList(pagingVO);
		pagingVO.setDataList(dataList);
		
		model.addAttribute("pagingVO", pagingVO);
		return "empNotice/empNoticeList";
	}
	
	// 직원용 공지사항 상세보기 띄우기 (비동기)
	@RequestMapping(value="/detail.do", method = RequestMethod.GET)
	public ResponseEntity<EmpNoticeVO> getEmpNoticeDetail(
			int empNoticeNo
			) {
		log.info("[getEmpNoticeDetail] 실행: empNoticeNo는? " + empNoticeNo);
		EmpNoticeVO empNoticeVO = noticeService.selectEmpNoticeDetail(empNoticeNo);
		return ResponseEntity.ok(empNoticeVO);
	}
	
	// 직원용 공지사항 상세보기 띄우기 (동기 방식)
	@RequestMapping(value="/detail", method = RequestMethod.GET)
	public String getEmpNoticeDetailPage(
			int empNoticeNo
			, Model model
			) {
		log.info("[getEmpNoticeDetail] 실행: empNoticeNo는? " + empNoticeNo);
		String goPage = "";
		EmpNoticeVO empNoticeVO = noticeService.selectEmpNoticeDetail(empNoticeNo);
		log.info("[getEmpNoticeDetail] VO값은? " + empNoticeVO);
		model.addAttribute("empNoticeVO", empNoticeVO);
		goPage = "empNotice/empNoticeDetail";
		return goPage;
	}
	
	// 직원용 공지사항 글수정 화면이동 및 업데이트 표시
	@GetMapping("/update")
	public String getEmpNoticeUpdateForm(int empNoticeNo, Model model) {
		log.info("[getEmpNoticeUpdateForm] 실행");
		EmpNoticeVO empNoticeVO = noticeService.selectEmpNoticeDetail(empNoticeNo);
		model.addAttribute("notice", empNoticeVO);
		model.addAttribute("status", "u");
		return "empNotice/empNoticeForm";
	}

	// 직원용 공지사항 상세보기 모달 창에서 수정 버튼 눌렀을 때 status 처리
	@RequestMapping("/status.do")
	public ResponseEntity<String> changeStatusToU(Model model) {
		log.info("[changeStatusToU] 실행");
		model.addAttribute("status", "u");
		String status = model.getAttribute("status").toString();
		return ResponseEntity.ok().body(status);
	}
	
	// 직원용 공지사항 등록시 status null 처리
	@RequestMapping("/reset.do")
	public ResponseEntity<String> resetStatus(Model model) {
		log.info("[resetStatus] 실행");
		model.addAttribute("status", "");
		String status = model.getAttribute("status").toString();
		return ResponseEntity.ok().body(status);
	}
	
	// 직원용 공지사항 글수정 처리
	@PostMapping("/update.do")
	public String updateEmpNoticeDetail(
			EmpNoticeVO empNoticeVO,
			Model model,
			HttpServletRequest req,
			RedirectAttributes ra
			) {
		log.info("[updateEmpNoticeDetail] 실행: Fix? " + empNoticeVO.getEmpNoticeFix());
		String goPage = "";
		ServiceResult result = noticeService.updateNotice(req, empNoticeVO);
		if(result.equals(ServiceResult.OK)) {
			log.info("[updateEmpNoticeDetail] 수정 성공");
			ra.addFlashAttribute("message", "공지사항 수정이 완료되었습니다.");
			model.addAttribute("status", "");
			goPage = "redirect:/emp/notice/detail?empNoticeNo="+empNoticeVO.getEmpNoticeNo();
		}else {
			log.info("[updateEmpNoticeDetail] 수정 실패");
			model.addAttribute("empNoticeVO", empNoticeVO);
			model.addAttribute("message", "수정에 실패했습니다. 다시 시도해주세요."	);
			model.addAttribute("status", "u");
			goPage = "empNotice/empNoticeForm";
		}
		return goPage;
	}
	
	// 직원용 공지사항 글수정 처리

	 @PostMapping("/edit.do")
	 public ResponseEntity<EmpNoticeVO> editEmpNoticeModal
	 		(
	 		@RequestBody EmpNoticeVO empNoticeVO, 
	 		Model model, RedirectAttributes ra
	 		) {
		log.info("[editEmpNoticeModal] 실행: Fix? " + empNoticeVO.getEmpNoticeFix());
//		log.info("[editEmpNoticeModal] VO: " + empNoticeVO);
		ServiceResult result = noticeService.updateNoticeModal(empNoticeVO);
		if(result.equals(ServiceResult.OK)) {
			log.info("[editEmpNoticeModal] 수정 성공");
			ra.addFlashAttribute("message", "공지사항 수정이 완료되었습니다.");
			return ResponseEntity.ok().body(empNoticeVO);
		}else {
			log.info("[editEmpNoticeModal] 수정 실패");
			model.addAttribute("empNoticeVO", empNoticeVO);
			model.addAttribute("message", "수정에 실패했습니다. 다시 시도해주세요." );
			model.addAttribute("status", "u");
			return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);
		}
	}

	
	// 직원용 공지사항 게시글 삭제 처리 (동기 방식)
	@RequestMapping("/delete")
	public String deleteEmpNoticeDetail(
			int empNoticeNo,
			HttpServletRequest req, RedirectAttributes ra, Model model
			) {
		log.info("[deleteNoticeDetail] 번호가져왔나요? " + empNoticeNo);
		String goPage = "";
		ServiceResult result = noticeService.deleteNotice(req, empNoticeNo);
		if(result.equals(ServiceResult.OK)) {
			log.info("[deleteNoticeDetail] 삭제 성공");
			ra.addFlashAttribute("message", "공지사항이 삭제되었습니다.");
			goPage = "redirect:/emp/notice/list";
		}else {
			log.info("[deleteNoticeDetail] 삭제 실패");
			ra.addFlashAttribute("message", "삭제하지 못했습니다. 다시 시도해주세요.");
			goPage = "redirect:/emp/notice/detail?empNoticeNo="+empNoticeNo;
		}
		return goPage;
	}
	
	// 직원용 공지사항 게시글 삭제 처리 (비동기 ajax 방식)
	@PostMapping("/delete.do")
	public ResponseEntity<Integer> deleteEmpNoticeModal(
			@RequestParam(name = "empNoticeNo", defaultValue = "0") int empNoticeNo,
			Model model
			){
		log.info("[deleteNoticeModal] 번호가져왔나요? " + empNoticeNo);
		ServiceResult result = noticeService.deleteNoticeModal(empNoticeNo);
		if(result.equals(ServiceResult.OK)) {
			log.info("[deleteNoticeDetail] 삭제 성공");
			return ResponseEntity.ok().body(1); // 삭제된 항목의 수 반환
		}else {
			log.info("[deleteNoticeModal] 삭제 실패");
			return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(0); // 실패시 0 반환
		}
	}
	
}

