<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>

<div class="main-content app-content">
	<div class="card card-custom">
		<div class="row">
			<div class="col-xl-12">
				<div class="card custom-card">
					<div class="card-header">
						<div class="card-title">수술목록</div>
					</div>
					<div class="card-body">
						<div class="table-responsive">
							<table id="vacation-table"
								class="table table-bordered text-nowrap w-100">
								<thead>
									<tr>
										<th>수술예약번호</th>
										<th>예약날짜</th>
										<th>환자이름</th>
										<th>수술종류</th>
										<th>집도의</th>
										<th>완료여부</th>
										<th>수술기록</th>
									</tr>
								</thead>
								<tbody>
<%-- 								<c:choose> --%>
<%-- 									<c:when test="${empty surgeryList}"> --%>
<!-- 										<tr> -->
<!-- 											<td colspan="9"> -->
<!-- 												수술 예약 목록이 없습니다. -->
<!-- 											</td> -->
<!-- 										</tr> -->
<%-- 									</c:when> --%>
<%-- 									<c:otherwise> --%>
										<c:forEach items="${surgeryList}" var="surgery">
											<tr>
												<td>${surgery.surgeryReservationNo }</td>
												<td>${surgery.surgeryReservationDate.substring(0,10)}</td>
												<td>${surgery.patntName }</td>
												<td>${surgery.surgeryKindName} </td>
												<td>${surgery.empName }</td>
										
									       <c:set var="resrvationNo" value="${surgery.surgeryReservationNo }"></c:set>
									       <c:set var="surgeryNo" value="${surgery.surgeryNo }"></c:set>
										<c:choose>
											 <c:when test="${!surgery.flagDate }">
												<td>수술예정 </td>
												<td>수술예정</td>
											</c:when>
											<c:otherwise>
												<td>수술완료 </td>
												<c:choose>
													<c:when test="${surgeryNo eq 0}">
														<td class="writeRecord" data-info='
														{ 
														"surgeryDoctorName" : "${surgery.empName }",
														"surgeryName" : "${surgery.surgeryKindName }",
														"surgeryDoctor" : "${surgery.surgeryDoctor }",
														"surgeryDate" : "${surgery.surgeryReservationDate }",
														"surgeryKindCode" : "${surgery.surgeryKindCode }",
														"orderNo" : "${surgery.orderNo }",
														"patntNo" : "${surgery.patntNo }" 
														}
														'>작성 </td>
													</c:when>
													<c:otherwise>
														<td class="checkRecord" data-surgeryno = "${surgeryNo }" >확인 </td>
													</c:otherwise>
												</c:choose>
											</c:otherwise>
										</c:choose>
										
											</tr>
										</c:forEach>
<%-- 									</c:otherwise> --%>
<%-- 								</c:choose> --%>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>




<div class="modal fade" id="formmodal" tabindex="-1"
aria-labelledby="exampleModalLabel" aria-hidden="true">
<div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <h6 class="modal-title" id="exampleModalLabel">수술 기록 작성</h6>
            <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Close"></button>
        </div>
        <div class="modal-body">
                <div class="mb-3">
                    <label for="recipient-name"
                        class="col-form-label">집도의</label>
                    <input type="text" class="form-control" id="surgeryDoctor" readonly="readonly">
                </div>
                <div class="mb-3">
                    <label for="recipient-name"
                        class="col-form-label">수술명</label>
                    <input type="text" class="form-control" id="surgeryName" readonly="readonly">
                </div>
                <div class="mb-3">
                    <label for="recipient-name"
                        class="col-form-label">경과시간</label>
                    <input type="text" class="form-control" id="surgeryElapse">
                </div>
                <div class="mb-3">
                    <label for="message-text"
                        class="col-form-label">기록</label>
                    <textarea class="form-control" id="surgeryComment"></textarea>
                </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="submitBtn">작성</button>
            <button type="button" class="btn btn-secondary" id="closeBtn"
                data-bs-dismiss="modal">닫기</button>
        </div>
    </div>
</div>
</div>
<script>
$(function(){
var info;
	$('.writeRecord').click(function(){
		info = JSON.parse($(this).data("info"));
		$('#surgeryDoctor').val(info.surgeryDoctorName);
		$('#surgeryName').val(info.surgeryName);
		$('#formmodal').modal("toggle");
		
		
	});
		$('#submitBtn').click(function(){
			let surgeryElapse = $('#surgeryElapse').val();
			let surgeryComment = $('#surgeryComment').val();
			let jsonData = {
					"surgeryElapse" : surgeryElapse,
					"surgeryComment" : surgeryComment
			}
			console.table(jsonData);
			
			let mergeJson = Object.assign({}, info, jsonData);
			console.table(mergeJson);
			$.ajax({
				url :"/surgeryRecord/insertsurgery",
				type : "post",
				data : JSON.stringify(mergeJson),
				
				contentType : "application/json;charset=utf-8",
				success : function(res){
					console.log(res)
					location.reload();
				}
			});
		});
	$('.checkRecord').click(function(){
		let surgeryNo = $(this).data("surgeryno");
		console.log(surgeryNo)
		$('#formmodal').modal("toggle");
	});
});

</script>