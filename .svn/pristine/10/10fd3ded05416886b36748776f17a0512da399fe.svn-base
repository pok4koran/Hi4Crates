<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>

<style>
img {
	width: 50px;
	height: auto;
	float: left;
}

.brightness {
	-webkit-filter: brightness(0.50);
	filter: brightness(0.50);
}

.opacity {
	-webkit-filter: opacity(50%);
	filter: opacity(50%);
}
</style>
</head>

<body>




	<!-- 본문 시작 -->
	<!-- Start::app-content -->
	<div class="main-content app-content">
		<div class="container-fluid">

			<!-- Start::row-1 -->
			<div class="row">
<!-- 				<div class="col-xxl-2 col-xl-12"> -->
				<div class="col-xl-2">
					<div class="row">
<!-- 						<div class="col-xxl-12 col-xl-6"> -->
						<div class="col-xl-12">
							<div class="card custom-card">

								<div class="card-header">
									<div class="card-title">환자 목록</div>
								</div>

								<div class="card-body p-0" id="waitingList">
								</div>
								
								<div class="card-footer">
								</div>
							</div>
						</div>
					</div>
				</div>

<!-- 				<div class="col-xxl-10 col-xl-12"> -->
				<div class="col-xl-4">

					<div class="card custom-card" style="height: 37vh;">
						<div class="card-header">
							<div class="card-title">오더 조회</div>
						</div>
						
						<div class="card-body" data-simplebar style="overflow-y: auto;">
							<ul class="list-group list-group-flush">
								<li class="list-group-item" id="order1">
									환자이름(성별/나이)
								</li>
								<li class="list-group-item" id="order2">
									오더종류
								</li>
								<li class="list-group-item" id="order3">
									치료부위
								</li>
								<li class="list-group-item" id="order4">
									진료차트내용? chart_record
								</li>
							</ul>
						</div>
						
					</div>

					<div class="row-xl-3">
						<div class="card custom-card" style="height: 37vh;">
							<div class="card-header">
								<div class="card-title">치료세팅 (장비 목록?)</div>
							</div>
							<div class="card-body" style="overflow-y: auto;">
								<div>
									<div>
	<!-- 									<p class="fw-semibold mb-3 d-flex align-items-center"> -->
										<p class="card-title text-muted fs-11 mb-0 d-flex align-items-center">
											(임시 메모) 치료·부위 복수선택해서 세팅하면 우상단 침상에 셋되고 카운트 시작<br>
											db에 저장X
										</p>
									</div>
									<div>
										<p class="card-title fw-semibold">치료부위 선택</p>
										<label for="treat1">치료부위1</label>
										<input type="checkbox" class="checkbox" name="treat1">
										<label for="treat2">치료부위2</label>
										<input type="checkbox" class="checkbox" name="treat2">
										<label for="treat3">치료부위3</label>
										<input type="checkbox" class="checkbox" name="treat3">
									</div>
									<hr>
									<div>
										<p class="card-title fw-semibold">치료장비 선택</p>
										<p class="card-title">온열치료 장비</p>
										<div>
											<label for="">온열장비1</label>
											<input type="checkbox" class="checkbox" name="">
											<label for="">온열장비2</label>
											<input type="checkbox" class="checkbox" name="">
											<label for="">온열장비3</label>
											<input type="checkbox" class="checkbox" name="">
										</div>
										<br>
										<p class="card-title">초음파 치료 장비</p>
										<div>
											<label for="">초음파장비1</label>
											<input type="checkbox" class="checkbox" name="">
											<label for="">초음파장비2</label>
											<input type="checkbox" class="checkbox" name="">
											<label for="">초음파장비3</label>
											<input type="checkbox" class="checkbox" name="">
										</div>
										<br>
										<p class="card-title">저주파 치료 장비</p>
										<div>
											<label for="">저주파장비1</label>
											<input type="checkbox" class="checkbox" name="">
											<label for="">저주파장비2</label>
											<input type="checkbox" class="checkbox" name="">
											<label for="">저주파장비3</label>
											<input type="checkbox" class="checkbox" name="">
										</div>
										<div>
											<button class="btn btn-info">확인</button>
										</div>
									</div>
									<span class="card-title text-muted fs-11 mb-0">
										환자 검색 조건: <br>
										LOC008	물리치료실<br>
										LOC009	물리치료대기실<br>
										LOC012	수납대기실<br>
										HS001	대기중<br>
										HS003	치료중<br>
										OD003	온열치료	ORDER<br>
										OD008	초음파치료	ORDER<br>
										OD009	충격파치료	ORDER
									</span>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="col-xl-6">
					<div class="row">
						<div class="col-xl-12">
							<div class="card custom-card">
								<div class="card-header d-flex justify-content-between">
									<div class="card-title">환자 배치</div>
								</div>
								<div class="card-body">
									<p>환자 이름, 사용중인 기기, 남은 시간을 어디에 배치할 것인가?</p>
									<p>여기서 버튼 눌러서 치료 마치면 아래 치료기록 입력 준비되도록</p>
									<div class="table-responsive">
										<table class="table text-nowrap table-bordered">
											<tr>
												<td>
													<div class="container">
														<!-- <div style="position: relative;" onclick="countDown('bed1');"> -->
														<img id="bed1"
															src="/resources/assets/img/bedtime-icon.svg"
															class="brightness opacity">
<!-- 														<div style="position: absolute;"> -->
														<div style="">
															<div id="bedName1"></div>
															<p>환자 이름 출력<br>
															(O성, 00세)</p>
														</div>
														<!-- </div> -->
													</div>
												</td>
												<td>
													<div class="container">
														<!-- <div style="position: relative;" onclick="countDown('bed2');"> -->
														<img id="bed2"
															src="/resources/assets/img/bedtime-icon.svg"
															class="brightness opacity">
														<!-- </div> -->
													</div>
												</td>
												<td>
													<div class="container">
														<!-- <div style="position: relative;" onclick="countDown('bed3');"> -->
														<img id="bed3"
															src="/resources/assets/img/bedtime-icon.svg"
															class="brightness opacity">
														<!-- </div> -->
													</div>
												</td>
											</tr>
											<tr>
												<td>
													<div id="bed1_1">
														<span style='color: #808080; font-size: large;'>00:00</span>
														<select class="">
															<option>기기목록</option>
															<option value="equip1">기기1</option>
															<option value="equip2">기기2</option>
															<option value="equip3">기기3</option>
														</select>
														<button class="btn btn-light">버튼</button>
													</div>
												</td>
												<td>
													<div id="bed2_1">
														<span style='color: #808080; font-size: large;'>00:00</span>
													</div>
												</td>
												<td>
													<div id="bed3_1">
														<span style='color: #808080; font-size: large;'>00:00</span>
													</div>
												</td>
											</tr>
											<tr>
												<td>
													<div class="container">
														<!-- <div style="position: relative;" onclick="countDown('bed4');"> -->
														<img id="bed4"
															src="/resources/assets/img/bedtime-icon.svg"
															class="brightness opacity">
														<!-- </div> -->
													</div>
												</td>
												<td>
													<div class="container">
														<!-- <div style="position: relative;" onclick="countDown('bed5');"> -->
														<img id="bed5"
															src="/resources/assets/img/bedtime-icon.svg"
															class="brightness opacity">
														<!-- </div> -->
													</div>
												</td>
												<td>
													<div class="container">
														<div style="position: relative;"
															onclick="countDown('bed6');">
															<img id="bed6"
																src="/resources/assets/img/bedtime-icon.svg"
																class="brightness opacity">
														</div>
													</div>
												</td>
											</tr>
											<tr>
												<td>
													<div id="bed4_1">
														<span style='color: #808080; font-size: large;'>00:00</span>
													</div>
												</td>
												<td>
													<div id="bed5_1">
														<span style='color: #808080; font-size: large;'>00:00</span>
													</div>
												</td>
												<td>
													<div id="bed6_1">
														<span style='color: #808080; font-size: large;'>00:00</span>
													</div>
												</td>
											</tr>
										</table>
									</div>
								</div>
							</div>
						</div>

						<div class="col-xl-12">
							<div class="card custom-card">
								<div class="card-header d-flex justify-content-between">
									<div class="card-title">치료 기록</div>
								</div>
								<div class="card-body">
									<textarea class="form-control" id="" placeholder="이게의미가있을까요"></textarea>
								</div>
								<div class="card-footer">
									<button class="btn btn-info">버튼</button>
								</div>
							</div>
						</div>
					</div>
				</div>

			</div>
			<!--End::row-1 -->





		</div>
	</div>
	<!-- End::app-content -->
	<!--본문 끝-->

</body>
<script type="text/javascript">
// 클릭 타이머 코드
var timer;
$("#bed1").on("click",function() {
	console.log("click 이벤트 인식 ");
	var image = $("#bed1");
	var isBrightness = image.hasClass("brightness");
	var isOpacity = image.hasClass("opacity");
	const bedded1 = document.getElementById('bed1_1');

	var time = 10;
	var min = "";
	var sec = "";
	// var isStopped = true;

	if (isBrightness && isOpacity) {
		console.log("class 존재 인식 ");
		clearInterval(timer); // 이미 진행 중인 카운트다운을 멈춤
		image.removeClass("brightness opacity");
		// bedded1.innerHTML = "<span style='color:blue;'>추가될 텍스트.</span>";

		var time = 10;
		timer = setInterval(function() {
			var min = parseInt(time / 60);
			var sec = time % 60;

			// document.getElementById("bed1_1").innerHTML = 
			bedded1.innerHTML =
// 				"<span style='color:#007AFF;font-size:large;text-shadow: -1px 0px white, 0px 1px white, 1px 0px white, 0px -1px white;'>" + 
				"<span style='font-size:large;'>" + min
					+ ":" + sec + "</span>";
			time--;

			if (time < 0) {
				clearInterval(timer);
				// 				document.getElementById("bed1_1").innerHTML = "0:0";
				image.addClass("brightness opacity");
				bedded1.innerHTML = "<span style='color:#808080;font-size:large;'>00:00</span>";
			}
		}, 1000);

	} else {
		console.log("class 없음");
		clearInterval(timer);
		image.addClass("brightness opacity");
		//	bedded1.innerHTML = "<span style='color:#808080;font-size:large;'>00:00</span>";
	}
});

// 대기 환자 목록 조회
function getWaitingList(){
	$.ajax({
		url: '/emp/physical/patnts',
		type: 'POST',
		dataType: 'json', // 서버에서 응답으로 JSON을 사용하는 경우
		success: function(data) {
			// 서버에서 받은 데이터를 처리하여 HTML 업데이트
			console.log("function getWaitingList()");
			console.log("data!!! " + data);
				
			let html = '';
			let sites = [
				{value: 'LOC008', text: '물리치료실'},
				{value: 'LOC009', text: '물리치료 대기실'},
				{value: 'LOC012', text: '수납 대기실'},
			];
			let states = [
				{value: 'HS001', text: '대기중'},
				{value: 'HS003', text: '치료중'},
			];

			// 환자 목록 생성
			$.each(data, function(index, item) {
				console.log("orderList")
				console.log(item);
				console.log(item.orderList);
				
				
				// 공통 서식 시작
				// (width: 232px;)
				html += '<div class="card border custom-card" style="background-color:white; width: 88%; height: 110px;margin-left: 10px;margin-bottom: 10px; margin-top: 5px;">';
				html += 	'<div class="card-header" style="height: 30px; background-color: #f6feff !important">';
				html += 		'<span class="fw-semibold fs-13" style="position: absolute; left: 12px; ">';
				// 장소 표시
				$.each(sites, function(index, site) {
					if (item.historyLoc === site.value) {
						html += site.text;
					}
					console.log("item.historyLoc: " + item.historyLoc);
					console.log("site.value: " + site.value);
				});
				
				html += 		'</span>';
				html += 	'</div>';
				html += 	'<div class="card-body p-3" style="width: 240px;height: 110px;margin-left: 10px;margin-bottom: 10px;">';
				html += 		'<div class="d-flex justify-content-between align-items-start mb-3 flex-wrap" style="">';
				html += 			'<div class="d-inline-flex align-items-start position-relative">';
				html += 				'<a href="javascript:void(0)" id="waitingMem" data-memNo="'+item.memNo+'" class="stretched-link"></a>';
				html += 				'<div class="flex-grow-1">';
				html += 					'<span class="mb-0 d-block fs-15 fw-semibold pickPt">';
				html += 						item.memName;
				html += 					'</span>';
				html += 					'<span class="fs-13 text-muted">';
				html += 						item.memGender + ', ' + item.memAge + '세'
				html += 					'</span>';
				html += 				'</div>';
				html += 			'</div>';
				// 환자 상태 표시(대기중/치료중)
				$.each(states, function(index, state) {
					if(state.value === 'HS003'){
						html += 						'<span class="fs-10 badge rounded-pill bg-secondary">';
					}else{
						html += 						'<span class="fs-10 badge rounded-pill bg-light text-dark">';
					}
					if (item.historyStatus === state.value) {
						html += state.text;
					}
					html += 			'</span>';
// 					console.log("item.historyStatus: " + item.historyStatus);
// 					console.log("state.value: " + state.value);
					
				});
				html += 		'</div>';
				html += 		'<input type="hidden" value="' + item.receiptNo + '" />';
				html += 	'</div>';
				html += '</div>';
				// 공통 서식 끝
				
			});	// $.each 끝
			
			// HTML 업데이트
			$('#waitingList').html(html);
		},	// success 끝
		error: function(xhr, status, error) {
			console.error(xhr.responseText); // 에러 처리
		}
	});
}	// getWaitingList() function 끝
// 페이지 로드 후 처음 한 번 요청을 실행
getWaitingList();
// 비동기 요청 반복 실행
setInterval(getWaitingList, 50000);
// 환자 클릭해서 오더 출력
$('body').on('click','#waitingMem',function(event){
	event.preventDefault();
	let memNo = $(this).attr('data-memNo');
	console.log("memNo: " + memNo);
	let data = {
		memNo : memNo
	}
	$.ajax({
		url : "/emp/physical/order",
		type : "post",
		contentType : "application/json",
		data : JSON.stringify(data),
		success : function (res) {
			console.log(res);
			
			// json데이터로 order 화면에 띄워주기(수정해야함)
			let order1 = $('#order1');
			let order2 = $('#order2');
			let order3 = $('#order3');
			let order4 = $('#order4');

			let html1 = "";
			let html2 = "";
			let html3 = "";
			let html4 = "";

			html1 += res.memName + " (" + res.memGender + ", " + res.memAge + "세)";
// 			html1 += "<br/>";
			
			html2 += "오더코드: " + res.orderVO.orderCode + " (";
			if(res.orderVO.orderCode === 'OD003'){
				html2 += "온열치료)";
			}else if(res.orderVO.orderCode === 'OD008'){
				html2 += "초음파치료)";
			}else{
				html2 += "충격파치료)";
			}
// 			html2 += "<br/>";
			
			html3 += "치료부위: " + res.orderVO.bodyCode; + "<br/>" 
			html3 += " ※ chartNo로 복수개 조회";
			
// 			html4 += "chartDate: " + res.chartVO.chartDate + "<br/>";
			html4 += "차트 기록: " + res.chartVO.chartRecord + "<br/>";
// 			html4 += "담당 의사(empNo in order): " + res.empVO.empNo + "<br/>"
			html4 += "담당 의사: " + res.docName + "<br/>"
			
			order1.html(html1);
			order2.html(html2);
			order3.html(html3);
			order4.html(html4);
		}
	});
});




</script>
</html>