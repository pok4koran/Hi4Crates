package kr.or.ddit.controller.comm;

import java.util.HashMap;

import javax.annotation.Resource;
import javax.inject.Inject;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import kr.or.ddit.service.ILoginService;
import kr.or.ddit.service.impl.LoginServiceImpl;
import kr.or.ddit.vo.MemberVO;
import lombok.extern.slf4j.Slf4j;

@Controller
@Slf4j
public class LoginController {
	
	@Inject
	private ILoginService loginService;
	
	@Resource(name="client_id")
	public String client_id;

	@Resource(name="redirect_uri")
	public String redirect_uri;
	
	@GetMapping("/login")
	public String loginForm(String error, String logout, Model model) {
		
		log.info("error : "+error);
		log.info("logout : "+logout);
		
		if(error != null) model.addAttribute("error", error);
		if(logout != null) model.addAttribute("logout", "로그아웃");
		
		String location = "https://kauth.kakao.com/oauth/authorize?response_type=code&client_id="+
				client_id+"&redirect_uri="+redirect_uri;
		model.addAttribute("location", location);
		
		return "loginForm";
	}

	
	@GetMapping("/logout")
	public String logoutForm() {
		return"logoutForm";
	}
	
	@GetMapping("/callback")
	public String callback(@RequestParam("code") String code) throws Exception {
		
		String goPage = "";
		
		log.info("code" + code);
		// Rest API KEY와 인가code로 로그인한 사용자의 token을 가져옵니다.
		String accessToken = loginService.getAccessTokenFromKakao(client_id, code);
		log.info("accessToken "+ accessToken);
		// token을 이용하여 로그인한 사용자의 정보를 map의 형태로 가져옵니다.
		HashMap<String, Object> userInfo = loginService.getUserInfo(accessToken);
		
		String id = (String) userInfo.get("id");
		String email = (String) userInfo.get("email");
		String name = (String) userInfo.get("name");
		String phone = (String) userInfo.get("phone");
		String birthYear = (String) userInfo.get("birthyear");
		String birthDay = (String) userInfo.get("birthday");
		String gender = (String) userInfo.get("gender");
		
		System.out.println(email);
		
		String kakaoPhone = phone.replace("+82 ", "0");
		String kakaoRegNo1 = birthYear.substring(2, 3) + birthDay;
		String kakaoGender = "남성";
		if(gender == "female") {
			kakaoGender = "여성";
		}
		
		MemberVO kakaoMember = new MemberVO();
		kakaoMember.setMemId(id);
		kakaoMember.setMemName(name);
		kakaoMember.setMemEmail(email);
		kakaoMember.setMemTel(kakaoPhone);
		kakaoMember.setMemRegno1(kakaoRegNo1);
		kakaoMember.setMemGender(kakaoGender);
		kakaoMember.setMemPw("1234");
		kakaoMember.setMemRegno2("1234567");
		kakaoMember.setMemType("test");
		
		log.info("id " + id);
		log.info("email " + kakaoMember.getMemEmail());
		log.info("phone " + phone);
		log.info("birthYear" + birthYear);
		log.info("birthDay " + birthDay);
		
		int status = loginService.kakaoInsert(kakaoMember);
		
		// 사용자 정보가 담긴 map의 사이즈가 0보다 크다면 사용자 정보가 있다는 것이고
		// 로그인에 성공한 것이다.
		if(userInfo.size() > 0) {
			goPage = "patient/home";
		}else {
			goPage = "redirect:/login/login.do";
		}
		
		return goPage;
	}
	
}
