<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>

<style>
img {
	width: 50px;
	height: auto;
	float: left;
}

.brightness {
	-webkit-filter: brightness(0.50);
	filter: brightness(0.50);
}

.opacity {
	-webkit-filter: opacity(50%);
	filter: opacity(50%);
}
.btn-sm {
	width: 3.25em;
	font-size: 8px;
/* 	display: flex; */
	align-items:center;
/* 	justify-content: center; */
}
.btn-bed {
	align-items:center;
	text-align: center;
	margin: 4px 15px;
}
</style>
</head>

<body>
	<!-- 본문 시작 -->
	<!-- Start::app-content -->
	<div class="main-content app-content">
		<div class="container-fluid">

			<!-- Start::row-1 -->
			<div class="row">
<!-- 				<div class="col-xxl-2 col-xl-12"> -->
				<div class="col-xl-2">
					<div class="row">
<!-- 						<div class="col-xxl-12 col-xl-6"> -->
						<div class="col-xl-12">
							<div class="card custom-card">

								<div class="card-header">
									<div class="card-title">환자 목록</div>
								</div>

								<div class="card-body p-0" id="waitingList">
								</div>
								
<!-- 								<div class="card-footer p-0"></div> -->
							</div>
						</div>
					</div>
				</div>

<!-- 				<div class="col-xxl-10 col-xl-12"> -->
				<div class="col-xl-4">

					<div class="card custom-card" style="height: 37vh;">
						<div class="card-header">
							<div class="card-title">오더 조회</div>
						</div>
						
						<div class="card-body" data-simplebar style="overflow-y: auto;">
							<ul class="list-group list-group-flush">
								<li class="list-group-item" id="order1">
									환자이름 (성별, 나이)
								</li>
								<li class="list-group-item" id="order2">
									오더종류
								</li>
								<li class="list-group-item" id="order3">
									치료부위
								</li>
								<li class="list-group-item" id="order4">
									진료차트
								</li>
							</ul>
						</div>
						
					</div>

					<div class="row-xl-3">
						<div class="card custom-card" style="height: 37vh;">
							<div class="card-header">
								<div class="card-title">치료세팅</div>
							</div>
							<div class="card-body" style="overflow-y: auto;">
								<div>
									<div>
	<!-- 									<p class="fw-semibold mb-3 d-flex align-items-center"> -->
									</div>
									<div>
										<p class="card-title fw-semibold">치료부위 </p>
										<div id="treatPart"></div>
									</div>
									<hr>
									<div>
										<p class="card-title fw-semibold">치료방법 </p>
										<div id="treat1"></div>
										<div id="treat2"></div>
										<div id="treat3"></div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="col-xl-6">
					<div class="row">
						<div class="col-xl-12">
							<div class="card custom-card">
								<div class="card-header d-flex justify-content-between">
									<div class="card-title">환자 배치</div>
								</div>
								<div class="card-body">
									<div class="table-responsive">
										<table class="table text-nowrap table-bordered">
											<tr>
												<td>
													<div id="bed1name"></div>
												</td>
												<td>
													<div id="bed2name"></div>
												</td>
												<td>
													<div id="bed3name"></div>
												</td>
											</tr>
											<tr>
												<td>
													<div class="container">
														<!-- <div style="position: relative;" onclick="countDown('bed1');"> -->
														<img id="bed1"
															src="/resources/assets/img/bedtime-icon.svg"
															class="brightness opacity">
<!-- 														<div style="position: absolute;"> -->
														<!-- </div> -->
													</div>
												</td>
												<td>
													<div class="container">
														<img id="bed2"
															src="/resources/assets/img/bedtime-icon.svg"
															class="brightness opacity">
														<!-- </div> -->
													</div>
												</td>
												<td>
													<div class="container">
														<img id="bed3"
															src="/resources/assets/img/bedtime-icon.svg"
															class="brightness opacity">
														<!-- </div> -->
													</div>
												</td>
											</tr>
											<tr>
												<td>
													<div class="container" style="display:flex;">
														<div id="bed1_1">
															<span style='color: #808080; font-size: large;'>00:00</span>
														</div>
														<div>
															<button class='btn btn-light btn-sm' id='bed1Done'>완료</button>
														</div>
													</div>
												</td>
												<td>
													<div class="container" style="display:flex;">
														<div id="bed2_1">
															<span style='color: #808080; font-size: large;'>00:00</span>
														</div>
														<div>
															<button class='btn btn-light btn-sm' id='bed2Done'>완료</button>
														</div>
													</div>
												</td>
												<td>
													<div class="container" style="display:flex;">
														<div id="bed3_1">
															<span style='color: #808080; font-size: large;'>00:00</span>
														</div>
														<div>
															<button class='btn btn-light btn-sm' id='bed3Done'>완료</button>
														</div>
													</div>
												</td>
											</tr>
											<tr>
												<td>
													<div id="bed4name"></div>
												</td>
												<td>
													<div id="bed5name"></div>
												</td>
												<td>
													<div id="bed6name"></div>
												</td>
											</tr>
											<tr>
												<td>
													<div class="container">
														<img id="bed4"
															src="/resources/assets/img/bedtime-icon.svg"
															class="brightness opacity">
														<!-- </div> -->
													</div>
												</td>
												<td>
													<div class="container">
														<img id="bed5"
															src="/resources/assets/img/bedtime-icon.svg"
															class="brightness opacity">
														<!-- </div> -->
													</div>
												</td>
												<td>
													<div class="container">
														<div style="position: relative;"
															onclick="countDown('bed6');">
															<img id="bed6"
																src="/resources/assets/img/bedtime-icon.svg"
																class="brightness opacity">
														</div>
													</div>
												</td>
											</tr>
											<tr>
												<td>
													<div class="container" style="display:flex;">
														<div id="bed4_1">
															<span style='color: #808080; font-size: large;'>00:00</span>
														</div>
														<div>
															<button class='btn btn-light btn-sm' id='bed4Done'>완료</button>
														</div>
													</div>
												</td>
												<td>
													<div class="container" style="display:flex;">
														<div id="bed5_1">
															<span style='color: #808080; font-size: large;'>00:00</span>
														</div>
														<div>
															<button class='btn btn-light btn-sm' id='bed5Done'>완료</button>
														</div>
													</div>
												</td>
												<td>
													<div class="container" style="display:flex;">
														<div id="bed6_1">
															<span style='color: #808080; font-size: large;'>00:00</span>
														</div>
														<div>
															<button class='btn btn-light btn-sm' id='bed6Done'>완료</button>
														</div>
													</div>
												</td>
											</tr>
										</table>
									</div>
								</div>
							</div>
						</div>

						<div class="col-xl-12">
							<div class="card custom-card" style="height: 31vh;">
								<div class="card-header d-flex justify-content-between">
									<div class="card-title">치료 기록</div>
								</div>
								<div class="card-body">
									<div id="reportInfo"></div>
									<div id="typeInfo"></div>
									<div id="selectArea"></div>
									<div>
										<textarea class="form-control" id="ptRecordContent" placeholder="치료 요약을 작성합니다."></textarea>
									</div>
								</div>
								<div class="card-footer">
									<button class="btn btn-info" id="finish">저장</button>
								</div>
							</div>
						</div>
					</div>
				</div>

			</div>
			<!--End::row-1 -->





		</div>
	</div>
	<!-- End::app-content -->
	<!--본문 끝-->

</body>
<script type="text/javascript">
// 대기 환자 목록 조회
function getWaitingList(){
	$.ajax({
		url: '/emp/physical/patnts',
		type: 'POST',
		dataType: 'json', // 서버에서 응답으로 JSON을 사용하는 경우
		success: function(data) {
			// 서버에서 받은 데이터를 처리하여 HTML 업데이트
			console.log("function getWaitingList()");
			console.log("data!!! " + data);
				
			let html = '';
			let sites = [
				{value: 'LOC008', text: '물리치료실'},
				{value: 'LOC009', text: '물리치료 대기실'},
				{value: 'LOC012', text: '수납 대기실'},
			];
			let states = [
				{value: 'HS001', text: '대기중'},
				{value: 'HS003', text: '치료중'},
			];

			// 환자 목록 생성
			$.each(data, function(index, item) {
				console.log("orderList");
				console.log(item);
				console.log(item.orderList);
				
				// 공통 서식 시작
				// (width: 232px;)
				html += '<div class="card border custom-card" style="background-color:white; width: 88%; height: 110px;margin-left: 10px;margin-bottom: 10px; margin-top: 5px;">';
				html += 	'<div class="card-header" style="height: 30px; background-color: #f6feff !important">';
				html += 		'<span class="fw-semibold fs-13" style="position: absolute; left: 12px; ">';
				// 장소 표시
				$.each(sites, function(index, site) {
					if (item.historyLoc === site.value) {
						html += site.text;
					}
					console.log("item.historyLoc: " + item.historyLoc);
					console.log("site.value: " + site.value);
				});
				
				html += 		'</span>';
				html += 	'</div>';
				html += 	'<div class="card-body p-3" style="width: 240px;height: 110px;margin-left: 10px;margin-bottom: 10px;">';
				html += 		'<div class="d-flex justify-content-between align-items-start mb-3 flex-wrap" style="">';
				html += 			'<div class="d-inline-flex align-items-start position-relative">';
				html += 				'<a href="javascript:void(0)" id="waitingMem" data-memNo="'+item.memNo+'" class="stretched-link"></a>';
				html += 				'<div class="flex-grow-1">';
				html += 					'<span class="mb-0 d-block fs-15 fw-semibold pickPt">';
				html += 						item.memName;
				html += 					'</span>';
				html += 					'<span class="fs-13 text-muted">';
				html += 						item.memGender + ', ' + item.memAge + '세'
				html += 					'</span>';
				html += 				'</div>';
				html += 			'</div>';
				// 환자 상태 표시(대기중/치료중)
				$.each(states, function(index, state) {
					if(state.value === 'HS003'){
						html += 						'<span class="fs-10 badge rounded-pill bg-secondary">';
					}else{
						html += 						'<span class="fs-10 badge rounded-pill bg-light text-dark">';
					}
					if (item.historyStatus === state.value) {
						html += state.text;
					}
					html += 			'</span>';
					
				});
				html += 		'</div>';
				html += 		'<input type="hidden" value="' + item.receiptNo + '" />';
				html += 	'</div>';
				html += '</div>';
				// 공통 서식 끝
				
			});	// $.each 끝
			
			// HTML 업데이트
			$('#waitingList').html(html);
		}	// success 끝
// 		error: function(xhr, status, error) {
// 			console.error(xhr.responseText); // 에러 처리
// 		}
	});
}	// getWaitingList() function 끝
// 대기환자 목록조회 끝
////////////////////////////////////////////////////////////////////////////////////////////////////
// 페이지 로드 후 처음 한 번 요청을 실행
getWaitingList();
// 비동기 요청 반복 실행
setInterval(getWaitingList, 60000);	// 실행간격 시간 설정
////////////////////////////////////////////////////////////////////////////////////////////////////
var memNo;
var memName;
var memGender;
var memAge;
var orderNo;
var empNo;
var therapyType;
// 환자 목록에서 환자 클릭시: 오더 & 치료세팅 출력
$('body').on('click','#waitingMem',function(event){
	event.preventDefault();
	memNo = $(this).attr('data-memNo');
	console.log("memNo: " + memNo);
	let data = {
		memNo : memNo
	};
	$.ajax({
		url : "/emp/physical/order",
		type : "post",
		contentType : "application/json",
		data : JSON.stringify(data),
		success : function (res) {
			console.log("res: " + res);
			
			// 오더 조회 구역
			let order1 = $('#order1');
			let order2 = $('#order2');
			let order3 = $('#order3');
			let order4 = $('#order4');
			// 치료세팅 구역
			let treatPart = $('#treatPart');
			let treat1 = $('#treat1');
			let treat2 = $('#treat2');
			let treat3 = $('#treat3');

			// 오더 조회에 뿌릴 html 코드 목록
			let html1 = "";
			let html2 = "";
			let html3 = "";
			let html4 = "";
			
			// 치료세팅에 뿌릴 html 코드 목록
			let htmlTreat = "";
			let htmlTreat1 = "";
			let htmlTreat2 = "";
			let htmlTreat3 = "";
			
			// 치료부위 값 담을 곳
			let bodyCodes = res.bodyCodes;

			// 값 세팅 시작
// 			memNo = res.memNo;
			memName = res.memName;
			memGender = res.memGender;
			memAge = res.memAge;
			
			// pt_record 기록용 정보 담기
			orderNo = res.orderVO.orderNo;
			empNo = res.orderVO.empNo;

			html1 += memName + " (" + memGender + ", " + memAge + "세)";
// 			html1 += "<br/>";
			html2 += "오더코드: ";
			// 오더코드 추가하며 치료세팅의 치료장비/치료종류 출력하기
			// 복수 출력해야 했던가? 확인 필요
			html2 += res.orderVO.orderCode + " (";
			if(res.orderVO.orderCode === 'OD003'){
				html2 += "온열치료)";
				htmlTreat1 += "온열 치료";
				therapyType = "온열 치료";
			}else if(res.orderVO.orderCode === 'OD008'){
				html2 += "초음파치료)";
				htmlTreat2 += "초음파 치료";
				therapyType = "초음파 치료";
			}else{
				html2 += "충격파치료)";
				htmlTreat3 += "충격파 치료";
				therapyType = "충격파 치료";
			}
// 			html2 += "<br/>";
			
			html3 += "치료부위: ";
			$.each(bodyCodes, function(index, idx) {
				html3 += idx.codeName;
				html3 += " ";
				// 여기에서 치료세팅의 치료부위 자리에도 값 넣기
				htmlTreat += idx.codeName;
			});
			html3 += "<br/>"; 
			
// 			html4 += "chartDate: " + res.chartVO.chartDate + "<br/>";
			html4 += "차트 기록: " + res.chartVO.chartRecord + "<br/>";
// 			html4 += "담당 의사(empNo in order): " + res.empVO.empNo + "<br/>";
			html4 += "담당 의사: " + res.docName + "<br/>";
			
			order1.html(html1);
			order2.html(html2);
			order3.html(html3);
			order4.html(html4);
			treatPart.html(htmlTreat);
			treat1.html(htmlTreat1);
			treat2.html(htmlTreat2);
			treat3.html(htmlTreat3);
		}
	});
});
////////////////////////////////////////////////////////////////////////////////////////////////////
var selectedTherapy;
//select에서 onchange로 값 선택
function selectedTherapyFunction(value){
	selectedTherapy = value;
	console.log("selectedTherapy: " + selectedTherapy);
}
////////////////////////////////////////////////////////////////////////////////////////////////////
//클릭 타이머 코드
var timer1;
// 침대별 값 세팅
var dataPtEqNo1;
var dataPtNo1 = "1";
var dataEmpNo1;
var dataOrderNo1;
var memNo1;
// 침대1 타이머
$("#bed1").on("click",function() {
	console.log("click 이벤트 인식 ");
	var image = $("#bed1");
	var isBrightness = image.hasClass("brightness");
	var isOpacity = image.hasClass("opacity");
	const bedded1 = document.getElementById('bed1_1');

	var time = 10;
	var min = "";
	var sec = "";
	// var isStopped = true;

	// 값 임시로 담아놓기
	dataEmpNo1 = empNo;
	dataOrderNo1 = orderNo;
	memNo1 = memNo;
	
	// 이미지 CSS로 상태 파악
	if (isBrightness && isOpacity) {
		console.log("class 존재 인식 ");
		clearInterval(timer1); // 이미 진행 중인 카운트다운을 멈춤
		image.removeClass("brightness opacity");
		// bedded1.innerHTML = "<span style='color:blue;'>추가될 텍스트.</span>";

		console.log("memNo1: " + memNo1);
		console.log("dataEmpNo1: " + dataEmpNo1);
		var dataNo = {
				"memNo": memNo1,
				"empNo": dataEmpNo1
			};
		// 값 가져가서 pt_status update 를 ajax로
		$.ajax({
			url : "/emp/physical/statusStart",
			type : "post",
			contentType : "application/json",
			data : JSON.stringify(dataNo),
			success : function (res) {
				console.log("환자 상태 변경 res: " + res);
				if (res === 'success'){
					console.log("환자 상태변경 성공!");
				}else{
					console.log("환자 상태변경 실패!!!!");
				}
			}
		});
		
		// 타이머 구역
		var time = 3;	// 카운트다운 시간 설정
		timer1 = setInterval(function() {
			var min = parseInt(time / 60);
			var sec = time % 60;

			bedded1.innerHTML =
				"<div class='container'>" +
					"<div class='inline-block'>" +
						"<div>" +
							"<span style='font-size:large;'>" + min
								+ ":" + sec + "</span>" +
						"</div>" +
					"</div>" +
				"</div>";
			time--;

			if (time < 0) {
				clearInterval(timer1);
				// 				document.getElementById("bed1_1").innerHTML = "0:0";
				image.addClass("brightness opacity");

				// 버튼을 통해 값을 어떻게 전송해야 할지 모르겠음
				// form을 만들어서 보내야 할지?
				bedded1.innerHTML = 
						"<div class='container'>"
							+ "<div class='inline-block'>"
								+ "<div>"
									+ "<span style='color:#808080;font-size:large;'>00:00</span>"
								+ "</div>"
							+ "</div>"
						+ "</div>";
				
				//(원래 환자배치 완료버튼 코드 있던 곳)
				
			}	// if (time < 0) 종료
		}, 1000);	// setInterval 끝
		// 타이머 구역 끝
		
		// 침대(환자배치 메뉴) '완료' 버튼 클릭 이벤트
		$("#bed1Done").on("click",function() {
			// 타이머 중단 및 이미지 변경
			clearInterval(timer1);
			image.addClass("brightness opacity");
			
			// 침대제목 비우기
			$('#bed1name').html("");
			// '치료 기록' 칸에 값 넣기
			// 환자 신상 입력
			let report =
					memName + " (" + memGender + ", " + memAge + "세)";
			$('#reportInfo').html(report);
			// 치료 종류 입력
			let typeInfo = $('#typeInfo');
			typeInfo.html(therapyType);
			console.log('typeInfo: ' + therapyType);
			// 사용한 치료 기기 선택
			// selectbox html 담을 공간
			let selectArea = $('#selectArea');
			let selectHtml = "";
			// typeInfo 종류에 따라 각각 다른 selectbox 구현
			if(therapyType === '온열 치료'){
				// db medical_equip 에서 리스트로 가져와서 Each로 빼기
				console.log('온열치료 selectbox');
				selectHtml += '<select class="form-select" onchange="selectedTherapyFunction(this.value)">';
					selectHtml += '<option value="1">' + "온열1" + '</option>';
					selectHtml += '<option value="2">' + "온열2" + '</option>';
					selectHtml += '<option value="3">' + "온열3" + '</option>';
				selectHtml += '</select>';
				selectArea.html(selectHtml);
			}else if(therapyType === '초음파 치료'){
				console.log('초음파치료 selectbox');
				selectHtml += '<select class="form-select" onchange="selectedTherapyFunction(this.value)">';
					selectHtml += '<option value="1">' + "초음파1" + '</option>';
					selectHtml += '<option value="2">' + "초음파2" + '</option>';
					selectHtml += '<option value="3">' + "초음파3" + '</option>';
				selectHtml += '</select>';
				selectArea.html(selectHtml);
			}else{
				console.log('충격파치료 selectbox');
				selectHtml += '<select class="form-select" onchange="selectedTherapyFunction(this.value)">';
					selectHtml += '<option value="1">' + "충격파1" + '</option>';
					selectHtml += '<option value="2">' + "충격파2" + '</option>';
					selectHtml += '<option value="3">' + "충격파3" + '</option>';
				selectHtml += '</select>';
				selectArea.html(selectHtml);
			}	// else 이벤트 종료
			
			// 치료 기록 입력 후 '완료' 버튼 눌렀을 때의 function 구현한 후 여기에서 실행
			// 필요한 값을 어떻게 전달할 것인가? 여러 명을 세팅했을 때 값이 꼬이지 않게 (침상마다 각각 만드나?)
				// 전달할 값?
					// memName, memGender, memAge, (=> memNo)
					// therapyType (혹은 typeInfo)
					// 치료기기 value (selectArea 값?)
				// 입력에 필요한 값: 
					//	private int ptRecordNo; // 오라클 시퀀스로 입력
					//	private int ptEqNo;	// 기기번호일 것...select option 값으로 전달
					//	private String ptRecordContent;	// 기록 내용(전달 필요)
					//	private String ptRecordDate;	// sysdate
					//	private int ptNo;	// 침상번호 (전달 필요... 함수 자체에 값 넣고 같은걸 6개 만들기?..)
					//	private int empNo;	// 담당자 번호 (담당의사? 물리치료사?)
					//	private int orderNo;	// 오더 번호 (jsp에서 값 받아서 넘길 수 없나?)
					//	=> ptEqNo(전역변수), ptRecordContent, ptNo(직접 값 지정), empNo, orderNo 값을 넘겨야 함
					// 	=>>	침대마다 일일이 위 항목 전역변수를 만들어?
				
			// 치료 기록 작성 후 '저장' 버튼 클릭 이벤트
			$("#finish").on("click",function() {
				// 보낼 값 정리
				dataPtNo1;	// "1" 들어있음
				dataEmpNo1;	// empNo 들어있음
				dataOrderNo1;	// orderNo 들어있음;
				let ptEqNo = selectedTherapy;	// onchange 함수로 구한 값
				let ptRecordContent = $('#ptRecordContent');	// textarea id로 가져옴
				
				// 치료기록 등록을 위한 data
				let dataa = {
						ptEqNo: ptEqNo,
						ptRecordContent: ptRecordContent,
						ptNo: dataPtNo1,
						empNo: dataEmpNo1,
						orderNo: dataOrderNo1,
						memNo: memNo1
				};
				
				// 치료기록 등록을 위해 data 전송
				// 컨트롤러에서 statusDone 합치기
				$.ajax({
					url : "/emp/physical/report",
					type : "post",
					contentType : "application/json",
					data : JSON.stringify(dataa),
					success : function (res) {
						console.log("환자 상태 변경 res: " + res);
						if (res === 'success'){
							console.log("치료기록 입력 성공!");
							$('#reportInfo').html("");
							$('#typeInfo').html("");
							$('#selectArea').html("");
						}else{
							console.log("치료기록 입력 실패!!!!!");
						}
					}	// success 끝
				});	// 치료기록 등록 ajax 끝
				
			});	// 치료기록 '저장' 버튼 클릭 이벤트 끝
						
		});	// 완료버튼 클릭이벤트 종료
		
		// 환자 정보 세팅 (침상배정 표 상단 tr)
		let bedName1 = $('#bed1name');
		let htmlName1 = '';
		htmlName1 += memName;
		htmlName1 += " (" + memGender + ", " + memAge + "세)";
		bedName1.html(htmlName1);
		
	} else {	// 이미지 CSS로 상태파악 끝
		// 한번 더 눌렀을 때
		console.log("class 없음");
		clearInterval(timer1);
		image.addClass("brightness opacity");
		//	bedded1.innerHTML = "<span style='color:#808080;font-size:large;'>00:00</span>";
	}
});
////////////////////////////////////////////////////////////////////////////////////////////////////

</script>
</html>