<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec"%>

<style type="text/css">
.ui-autocomplete {
  max-height: 200px;
  overflow-y: auto;
  /* prevent horizontal scrollbar */
  overflow-x: hidden;
  height: auto;
}

.ui-menu-item div.ui-state-hover,
.ui-menu-item div.ui-state-active {
  color: #ffffff;
  text-decoration: none;
  background-color: #f6B664;
  border-radius: 0px;
  -webkit-border-radius: 0px;
  -moz-border-radius: 0px;
  background-image: none;
  border:none;
}
#waitingList{
overflow-y:auto;
	max-width:100%;
}
#waitingList .custom-card{
	    height: 95px;
	    width: 90%;
	    margin: 5%
	}
</style>

<body>

<!-- 	<div class="page"> -->

		<div class="main-content app-content">
			<!-- <div class="container-fluid"> -->

				<!-- Start::row-1 -->
				<div class="row" style="padding-left: 12px;">
					<div class="col-xxl-2 col-xl-12">
						<div class="col-xxl-12 col-xl-6">
							<div class="card custom-card"  style="height:880px;" >
								<div class="card-header justify-content-between">
									<div class="card-title">환자목록</div>
								</div>
								<div class="card-body" id="waitingList" style="overflow-y: auto;padding-left: 0px;padding-top: 3px;">
									
								</div>
							</div>
						</div>
					</div>
					<!-- 차트 div  -->
					<div class="col-xxl-10 col-xl-12">
					
					<div id="chartView">
						<div class="row" style="background-color: white; border-radius: 1%;">
							<div class="col-xl-3" style="border-right: solid 1px rgb(229, 228, 228);height: 880px;">
								<div class="col-xl-12">
									<div class="card custom-card">
										<div class="card-header  justify-content-between">
											<div class="card-title">내원이력</div>
										</div>
										<div class="card-body" style="overflow-y: scroll; height: 500px;"  >
											<div>
                                                    <ul class="list-unstyled mb-0 crm-recent-activity">
                                                        <li class="crm-recent-activity-content"  id="record-body" style="overflow-y: auto;max-height: 780px;">
                                                           
                                                        </li>
                                                       
                                                    </ul>
                                                </div>
										</div>
									</div>
								</div>
								<div class="col-xxl-12 col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
								</div>
							</div>
							<div class="col-xl-4">
								<div class="row">
									<div class="col-xl-12" style="padding-top: 12px;">
										<div class="card custom-card"
											style="border: solid 1px rgb(229, 228, 228);height: 480px;">
											<div class="card-header justify-content-between">
												<div class="card-title">진료기록</div>
											</div>
											<div class="card-body">
												<div class="content-wrapper">
												</div>
											</div>
										</div>
									</div>
									<div class="col-xl-12">
										 <div class="card custom-card" style="border: solid 1px rgb(229, 228, 228); height:330px;">
                                            <div class="card-header justify-content-between">
                                                <div class="card-title">
                                                   		진단 및 처방
                                                </div>
                                        	</div>
											<div class="card-body" style="margin-top: -2%;">
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-xl-5"
								style="border-left: solid 1px rgb(229, 228, 228);">
								<div class="row">
									<div class="col-xxl-12 col-xl-12">
										<div class="row">
											<div class="col-xl-12">
												<div class="col-xl-12" style="padding-top: 12px;">
													<div class="card custom-card" style="border: solid 1px rgb(229, 228, 228); height:600px;">
			                                            <div class="card-header justify-content-between">
			                                                <div class="card-title">
			                                                   	차트 작성
			                                                </div>
			                                        	</div>
														<div class="card-body" style="margin-top: -2%;" id="insertChartArea">
															<input type="text" id="patntNo" readonly="readonly">
															<input type="text" id="receiptNo" readonly="readonly">
															환자명 : <input type="text" class="form-control" id="patntName" readonly="readonly"/>
															<!-- 로그인한 사용자 자동으로 들어가게? -->
															작성자 : <input type="text" class="form-control" id="empName" readonly="readonly"> 
															<textarea class="form-control" rows="10" cols="30" id="nursingContent"
															style="resize : none;"></textarea>
															<button type="button" class="btn btn-sm btn-info" id="insertChartBtn">Insert</button>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					</div>
				</div>
				<!-- <div class="col-xxl-2 col-xl-12"> -->

			</div>
			<!-- End::row-1 -->

<!-- 		</div> -->
<!-- 	</div> -->
	<!-- End::app-content -->

	<div class="modal fade" id="searchModal" tabindex="-1"
		aria-labelledby="searchModal" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-body">
					<div class="input-group">
						<a href="javascript:void(0);" class="input-group-text"
							id="Search-Grid"><i
							class="fe fe-search header-link-icon fs-18"></i></a> <input
							type="search" class="form-control border-0 px-2"
							placeholder="Search" aria-label="Username"> <a
							href="javascript:void(0);" class="input-group-text"
							id="voice-search"><i class="fe fe-mic header-link-icon"></i></a>
						<a href="javascript:void(0);" class="btn btn-light btn-icon"
							data-bs-toggle="dropdown" aria-expanded="false"> <i
							class="fe fe-more-vertical"></i>
						</a>
						<ul class="dropdown-menu">
							<li><a class="dropdown-item" href="javascript:void(0);">Action</a></li>
							<li><a class="dropdown-item" href="javascript:void(0);">Another
									action</a></li>
							<li><a class="dropdown-item" href="javascript:void(0);">Something
									else here</a></li>
							<li><hr class="dropdown-divider"></li>
							<li><a class="dropdown-item" href="javascript:void(0);">Separated
									link</a></li>
						</ul>
					</div>
					<div class="mt-4">
						<p class="font-weight-semibold text-muted mb-2">Are You
							Looking For...</p>
						<span class="search-tags alert"><i class="fe fe-user me-2"></i>People<a
							href="javascript:void(0)" class="tag-addon"
							data-bs-dismiss="alert"><i class="fe fe-x"></i></a></span> <span
							class="search-tags alert"><i class="fe fe-file-text me-2"></i>Pages<a
							href="javascript:void(0)" class="tag-addon"
							data-bs-dismiss="alert"><i class="fe fe-x"></i></a></span> <span
							class="search-tags alert"><i class="fe fe-align-left me-2"></i>Articles<a
							href="javascript:void(0)" class="tag-addon"
							data-bs-dismiss="alert"><i class="fe fe-x"></i></a></span> <span
							class="search-tags alert"><i class="fe fe-server me-2"></i>Tags<a
							href="javascript:void(0)" class="tag-addon"
							data-bs-dismiss="alert"><i class="fe fe-x"></i></a></span>
					</div>
					<div class="my-4">
						<p class="font-weight-semibold text-muted mb-2">Recent Search
							:</p>
						<div
							class="p-2 border br-5 d-flex align-items-center text-muted mb-2 alert">
							<a href="notifications.html"><span>Notifications</span></a> <a
								class="ms-auto lh-1" href="javascript:void(0);"
								data-bs-dismiss="alert" aria-label="Close"><i
								class="fe fe-x text-muted"></i></a>
						</div>
						<div
							class="p-2 border br-5 d-flex align-items-center text-muted mb-2 alert">
							<a href="alerts.html"><span>Alerts</span></a> <a
								class="ms-auto lh-1" href="javascript:void(0);"
								data-bs-dismiss="alert" aria-label="Close"><i
								class="fe fe-x text-muted"></i></a>
						</div>
						<div
							class="p-2 border br-5 d-flex align-items-center text-muted mb-0 alert">
							<a href="mail.html"><span>Mail</span></a> <a class="ms-auto lh-1"
								href="javascript:void(0);" data-bs-dismiss="alert"
								aria-label="Close"><i class="fe fe-x text-muted"></i></a>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<div class="btn-group ms-auto">
						<button type="button" class="btn btn-sm btn-primary-light">Search</button>
						<button type="button" class="btn btn-sm btn-primary">Clear
							Recents</button>
					</div>
				</div>
			</div>
		</div>
	</div>


	<!-- Prism JS -->
	<script
		src="${pageContext.request.contextPath }/resources/assets/libs/prismjs/prism.js"></script>
	<script
		src="${pageContext.request.contextPath }/resources/assets/js/prism-custom.js"></script>

	<!-- Filepond JS -->
	<script
		src="${pageContext.request.contextPath }/resources/assets/libs/filepond/filepond.min.js"></script>
	<script
		src="${pageContext.request.contextPath }/resources/assets/libs/filepond-plugin-image-preview/filepond-plugin-image-preview.min.js"></script>
	<script
		src="${pageContext.request.contextPath }/resources/assets/libs/filepond-plugin-image-exif-orientation/filepond-plugin-image-exif-orientation.min.js"></script>
	<script
		src="${pageContext.request.contextPath }/resources/assets/libs/filepond-plugin-file-validate-size/filepond-plugin-file-validate-size.min.js"></script>
	<script
		src="${pageContext.request.contextPath }/resources/assets/libs/filepond-plugin-file-encode/filepond-plugin-file-encode.min.js"></script>
	<script
		src="${pageContext.request.contextPath }/resources/assets/libs/filepond-plugin-image-edit/filepond-plugin-image-edit.min.js"></script>
	<script
		src="${pageContext.request.contextPath }/resources/assets/libs/filepond-plugin-file-validate-type/filepond-plugin-file-validate-type.min.js"></script>
	<script
		src="${pageContext.request.contextPath }/resources/assets/libs/filepond-plugin-file-validate-type/filepond-plugin-file-validate-type.min.js"></script>
	<script
		src="${pageContext.request.contextPath }/resources/assets/libs/filepond-plugin-image-crop/filepond-plugin-image-crop.min.js"></script>
	<script
		src="${pageContext.request.contextPath }/resources/assets/libs/filepond-plugin-image-resize/filepond-plugin-image-resize.min.js"></script>
	<script
		src="${pageContext.request.contextPath }/resources/assets/libs/filepond-plugin-image-transform/filepond-plugin-image-transform.min.js"></script>


	<!-- Dropzone JS -->
	<script
		src="${pageContext.request.contextPath }/resources/assets/libs/dropzone/dropzone-min.js"></script>

	<!-- Fileupload JS -->
	<script
		src="${pageContext.request.contextPath }/resources/assets/js/fileupload.js"></script>

	
	<!-- JSVector Maps JS -->
	<script
		src="${pageContext.request.contextPath }/resources/assets/libs/jsvectormap/js/jsvectormap.min.js"></script>

	<!-- JSVector Maps MapsJS -->
	<script
		src="${pageContext.request.contextPath }/resources/assets/libs/jsvectormap/maps/world-merc.js"></script>





    <!-- Select2 Cdn -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- Internal Select-2.js -->
    <script src="${pageContext.request.contextPath }/resources/assets/js/select2.js"></script>
    
    


</body>
<script type="text/javascript">
	$(function() {
		
		$.ajax({
			url : "/nurse/getWaitingPatntList",
			type : "post",
			beforeSend: function(xhr) {
		        xhr.setRequestHeader($("meta[name='_csrf_header']").attr("content"), $("meta[name='_csrf']").attr("content"));
			},
			success : function(res) {
				console.log(res);
				let waitingList = $('#waitingList');
				let html = "";
				$.each(res, function(index, item) {
					html += '<div class="card border custom-card" style="background-color:white;width: 170px;height: 110px;margin-left: 10px;margin-bottom: 10px; margin-top: 5px;">'+
		            '<div class="card-header" style="height: 30px; background-color: #f6feff !important">'+
		            '<span class="fw-semibold fs-13" style="position: absolute; left: 12px; ">' + item.codeName + '</span>'+
		            '</div>'+
		            '<div class="card-body p-2" >'+
		            '<div class="d-flex justify-content-between align-items-start mb-3 flex-wrap" style="padding-left: 10px;padding-top: 5px;">'+
		            '<div class="d-inline-flex align-items-start position-relative">'+
		            // '<a href="profile.html" class="stretched-link"></a>'+
		            '<div class="flex-grow-1 patntList" data-mem-no="' + item.memNo + '" data-patnt-no="' + item.patntNo + '"'+
		            'data-receipt-no="' + item.receiptNo + '">' +
		            '<span class="mb-0 d-block fs-15 fw-semibold pickPt memName">' + item.memName + '</span>'+
		            '<span class="fs-13 text-muted">' + item.memGender + ' ' + item.memAge + '세</span>'+
		            '</div>' +
		            '</div>' +
		            '<span class="fs-10 badge rounded-pill bg-secondary">' + item.ccodeName + '</span>'+
		            
		            '</div>' +
		            '<input type="hidden" value="'+item.receiptNo+'" />'+
		            '</div>' +
		            '</div>';
				});
				waitingList.html(html);
			}
		});
		
		//대기 환자 클릭이벤트
		$(document).on('click', '.patntList', function() {
			console.log('대기환자클릭체킁');
			let memNo = $(this).data('mem-no');
			let patntNo = $(this).data('patnt-no');
			let receiptNo = $(this).data('receipt-no');
			
			let patntNoInput = $('#patntNo');
			patntNoInput.val(patntNo);
			
			 let memName = $(this).find('.memName').text();
			console.log(memName);
			
			let patntNameInput = $('#patntName');
			patntNameInput.val(memName);
			
			let receiptNoInput = $('#receiptNo');
			receiptNoInput.val(receiptNo);
			
			console.log(memNo);
			
			let data = {
				memNo : memNo
			};
			
			// 환자 상세정보
			$.ajax({
				url : "/nurse/getPatntInfo",
				type : "post",
				data : JSON.stringify(data),
				beforeSend: function(xhr) {
			        xhr.setRequestHeader($("meta[name='_csrf_header']").attr("content"), $("meta[name='_csrf']").attr("content"));
				},
				contentType : "application/json",
				success : function(res) {
					console.log(res);
					
					let memNo = res.memNo;
					let memName = res.memName;
					let memAge = res.memAge;
					let memGender = res.memGender;
					let memRegNo1 = res.memRegno1; // 주민번호 앞자리
					let memRegNo2 = res.memRegno2; // 주민번호 뒷자리
					let memTel = res.memTel;		
					let memAddTel = res.memAddtel;	// 추가연락처
					
					let protectorVO = res.protectorVO;	// 보호자vo
					let particularVO = res.particularVO; // 특이사항vo
					
					
					// 보호자 정보가 존재하는 경우
					if (protectorVO != null) {
						let protectorName = protectorVO.protectorName; // 보호자명
						let protectorTel = protectorVO.protectorTel;	// 보호자 연락처
						let protectorRelate = protectorVO.protectorRelate; // 보호자 관계
					}
					
					// 특이사항 정보가 존재하는 경우
					if (particularVO != null) {
						let particularDescription = particularVO.particularDescription; // 특이사항 내용
					}
					
				}
				
			});
			
			// 내원이력 (수납 완료된거만) 가져오기
			$.ajax({
				url : "/nurse/getHistoryList",
				type : "post",
				beforeSend: function(xhr) {
			        xhr.setRequestHeader($("meta[name='_csrf_header']").attr("content"), $("meta[name='_csrf']").attr("content"));
				},
				data : JSON.stringify(data),
				contentType : "application/json",
				success : function(res) {
					console.log("내원이력");
					console.log(res);
					// 내원이력 리스트 추가
					var html = "";
					var chartData = []; // 빈 배열 생성

					 for (var i = 0; i < res.length; i++) {
					        var currentChartData = res[i].chartNo; // 현재 요소의 chartNo를 가져와 변수에 할당

					        // 이미 chartData 객체에 해당 chartNo가 존재한다면
					        if (chartData[currentChartData]) {
					            // 해당 chartNo의 데이터에 새로운 주상병을 추가
					            chartData[currentChartData].chartVO.disNameKr.push(res[i].chartVO.disNameKr);
					        } else {
					            // chartNo가 존재하지 않는 경우, 새로운 객체를 생성하고 주상병을 추가
					            chartData[currentChartData] = {
					                chartNo: res[i].chartNo,
					                receiptDate: res[i].receiptDate,
					                memName: res[i].memName,
					                chartVO: {
					                    disNameKr: [res[i].chartVO.disNameKr] // 주상병을 배열로 저장
					                }
					            };
					        }
					    }

					    console.log("chartData:", chartData); // chartData에 chartNo가 같은 요소들이 묶여 있는 것을 확인

					    // chartData를 HTML로 변환하여 추가
					    for (var key in chartData) {
					        var data = chartData[key];
					        var datetimeString = data.receiptDate;
					        var parts = datetimeString.split(" ");
					        var datePart = parts[0];
					        var timePart = parts[1];
					        var timeParts = timePart.split(":");
					        var hour = timeParts[0];
					        var minute = timeParts[1];

					        html += '<div class="d-flex align-items-top">';
					        html += '<div class="me-3">';
					        html += '<span class="avatar avatar-xs bg-primary-transparent avatar-rounded">';
					        html += '<i class="bi bi-circle-fill fs-8"></i>';
					        html += '</span>';
					        html += '</div>';
					        html += '<div class="crm-timeline-content">';
					        html += '<span>' + datePart + '</span><br>';
					        html += '<span>' + data.memName + '</span><br>';
					        for (var j = 0; j < data.chartVO.disNameKr.length; j++) {
					        	html += '<span>';
					            html += data.chartVO.disNameKr[j];
					            if (j < data.chartVO.disNameKr.length - 1) {
					                html += '</span>, <br>';
					            } else {
					                html += '</span>';
					            }
					        }
					        html += '</span><br>';
					        html += '<span class="badge rounded-pill bg-dark-transparent">' + formatNumber(data.chartNo) + '</span>';
					        html += '</div>';
					        html += '<div class="flex-fill text-end">';
					        html += '<span class="d-block text-muted fs-11 op-7">' + hour + ':' + minute + '</span>';
					        html += '</div>';
					        html += '</div>';
					    }
					$("#record-body").html(html);
				}
			});
		});
		
		// 내원이력 리스트 중 하나를 클릭하면 chartNo 가져와서 order 조회하기
		$(document).on("click", ".list", function() {
			let chartData = {
				chartNo : 144 // 임시로 넣음
			};
			
			$.ajax({
				url : "/nurse/getHistoryInfo",
				type : "post",
				beforeSend: function(xhr) {
			        xhr.setRequestHeader($("meta[name='_csrf_header']").attr("content"), $("meta[name='_csrf']").attr("content"));
				},
				data : JSON.stringify(chartData),
				contentType : "application/json",
				success : function(res) {
					console.log("내원이력");
					console.log(res);
				}
			});
			
			// 대기환자 오더 조회
			$.ajax({
				url : "/nurse/getPatntOrder",
				type : "post",
				beforeSend: function(xhr) {
			        xhr.setRequestHeader($("meta[name='_csrf_header']").attr("content"), $("meta[name='_csrf']").attr("content"));
				},
				data : JSON.stringify(chartData),
				contentType : "application/json",
				success : function(res) {
					console.log("getOrder!!");
					console.log(res);
				}
			});
		});
		
		
		let insertChartBtn = $('#insertChartBtn');
		insertChartBtn.click(function() {
			let patntNo = $('#patntNo').val();
			let receiptNo = $('#receiptNo').val();
			console.log("patntNo", patntNo);
			console.log("receiptNo", receiptNo);
			let nursingContent = $('#nursingContent').val();
			
			console.log("nursingContent", nursingContent);
			
			let data = {
				patntNo : patntNo,
				receiptNo : receiptNo,
				nursingContent : nursingContent
				// empNo 추가해야함
			};
			
			// 간호기록 차트 다시하기
			$.ajax({
				url : "/nurse/insertNursingRecord",
				type : "post",
				beforeSend: function(xhr) {
			        xhr.setRequestHeader($("meta[name='_csrf_header']").attr("content"), $("meta[name='_csrf']").attr("content"));
				},
				data : JSON.stringify(data),
				contentType : "application/json",
				success : function(res) {
					console.log(res);
				}
			});
		});
	});
	
	

</script>


</html>