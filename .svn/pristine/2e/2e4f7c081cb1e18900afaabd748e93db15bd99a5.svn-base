<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.css">

<!-- FullCalendar Moment.js -->
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>

<!-- FullCalenar Javascript -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.js"></script>


<!-- FullCalendar Locale -->
<script
	src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales-all.js"></script>
<!-- <style> -->
<!-- </style> -->
<div class="main-content app-content">
	<div class="container-fluid">
		<div class="row">
			<div class="col-xl-2" style="margin:-5px">
				<div class="card custom-card" style="height: 790px;">
					<!-- 제목 시작 -->
					<div class="card-header justify-content-between">
						<div class="card-title">수술 예약 대기 환자</div>
					</div>
					<div id="placeReserveList">
						<c:forEach var="surgeryReservWaitingVO"
							items="${surgeryWaitingList }">
							<div class="card border custom-card"
								style="background-color: white; width: 233px; height: 110px; margin-left: 10px; margin-bottom: 10px; margin-top: 5px;">
								<div class="card-header"
									style="height: 30px; background-color: #f6feff !important">
									<span class="fw-semibold fs-13"
										style="position: absolute; left: 12px; top: 7px;">${surgeryReservWaitingVO.clinicName}</span>
								</div>
								<div class="card-body p-2"
									style="width: 240px; height: 110px; margin-left: 10px; margin-bottom: 10px;">
									<div
										class="d-flex justify-content-between align-items-start mb-3 flex-wrap"
										style="">
										<div class="d-inline-flex align-items-start position-relative">
											<div class="flex-grow-1">
												<a href="#" class="surgeryMem" 
												data-data='{
												"surgeryReservationNo" : "${surgeryReservWaitingVO.surgeryReservationNo }",
												"doctorName" : "${surgeryReservWaitingVO.doctorName }",
												"patntName" : "${surgeryReservWaitingVO.patntName }",
												"patntAge" : "${surgeryReservWaitingVO.memAge }",
												"patntGender" : "${surgeryReservWaitingVO.memGender }",
												"patntTel" : "${surgeryReservWaitingVO.memTel }",
												"surgeryKindName" : "${surgeryReservWaitingVO.surgeryKindName }",
												"bodycodeName" : "${surgeryReservWaitingVO.bodycodeName }",
												"surgeryDoctor" : "${surgeryReservWaitingVO.surgeryDoctor }"
 												}'><span class="mb-0 d-block fs-15 fw-semibold">${surgeryReservWaitingVO.patntName}</span></a>
												<span class="fs-13 text-muted">${surgeryReservWaitingVO.memGender },
													${surgeryReservWaitingVO.memAge}세</span>
											</div>
										</div>
										<span class="fs-10 badge rounded-pill bg-secondary" style="margin-right:20px;">${surgeryReservWaitingVO.historyName}</span>
									</div>
								</div>
							</div>
						</c:forEach>
					</div>
				</div>
			</div>
			<div class="col-xl-3" style="margin:-5px">
        <div class="card custom-card" style="height: 790px;">
            <div class="card-header justify-content-between">
                    <div class="card-title">환자 상세정보</div>
            </div>
            <div class="card-body">
                <table class="table text-nowrap table-bordered border-primary" style="margin: -15px; margin-top: -5px;">
                    <tbody id="table">
                        <tr>
                            <th scope="row" class="me-2 fw-semibold">
                                    주치의
                            </th>
                            <td>
                                <span id="doctorName"></span>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row" class="me-2 fw-semibold">
                                    이름
                            </th>
                             <td>
                                <span id="patntName"></span>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row" class="me-2 fw-semibold">
                                       성별
                            </th>
                             <td>
                                <span id="patntGender"></span>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row" class="me-2 fw-semibold">
                                       나이
                            </th>
                             <td>
                                <span id="patntAge"></span>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row" class="me-2 fw-semibold">
                                       전화번호
                            </th>
                             <td>
                                <span id="patntTel"></span>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row" class="me-2 fw-semibold">
                                       수술 종류
                            </th>
                             <td>
                                <span id="surgeryName"></span>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row" class="me-2 fw-semibold">
                                       수술 부위
                            </th>
                             <td>
                                <span id="bodypartName"></span>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row" class="me-2 fw-semibold">
                                    보호자 이름
                            </th>
                             <td>
                                <input type="text" class="form-control" id="protectorName" style="width: 250px;float: left;padding-top: 4px;padding-bottom: 3px;" >
                            </td>
                        </tr>
                        <tr>
                            <th scope="row" class="me-2 fw-semibold">
                                보호자 연락처
                            </th>
                             <td>
                                <input type="text" class="form-control" id="protectorTel" style="width: 250px;float: left;padding-top: 4px;padding-bottom: 3px;" >
                            </td>
                        </tr>
                        <tr>
                            <th scope="row" class="me-2 fw-semibold">
                                    관계
                            </th>
                             <td>
                                <input type="text" class="form-control" id="protetorRelate" style="width: 250px;float: left;padding-top: 4px;padding-bottom: 3px;" >
                            </td>
                        </tr>
                        <tr>
                            <th scope="row" class="me-2 fw-semibold">
                                    예약 날짜
                            </th>
                             <td>
                                <input type="text" class="form-control" id="surgeryReservDate" style="width: 250px;float: left;padding-top: 4px;padding-bottom: 3px;" readonly>
                            </td>
                        </tr>
                       
                        <!-- 시간 셀렉트박스 -->
                        <tr>
                            <th scope="row" class="me-2 fw-semibold">
                                예약 시간
                            </th>
                            <td>
                                <select name="reservation_time" id="surgeryReservTime" class="form-select custom-select">
                                    <!-- <option value="">원하는 진료시간을 선택하세요.</option> -->
                                     <option selected=""></option>
                                    <!-- 9:00부터 12:00까지 -->
                                    <optgroup label="오전">
                                        <option value="09:00">9:00</option>
                                        <option value="09:30">9:30</option>
                                        <option value="10:00">10:00</option>
                                        <option value="10:30">10:30</option>
                                        <option value="11:00">11:00</option>
                                        <option value="11:30">11:30</option>
                                        <!-- <option value="12:00">12:00</option> -->
                                    </optgroup>
                                    <!-- 13:00부터 18:00까지 -->
                                    <optgroup label="오후">
                                        <option value="13:00">13:00</option>
                                        <option value="13:30">13:30</option>
                                        <option value="14:00">14:00</option>
                                        <option value="14:30">14:30</option>
                                        <option value="15:00">15:00</option>
                                        <option value="15:30">15:30</option>
                                        <option value="16:00">16:00</option>
                                        <option value="16:30">16:30</option>
                                        <option value="17:00">17:00</option>
                                        <option value="17:30">17:30</option>
                                    </optgroup>
                                </select>
                            </td>
                         </tr>
                        <tr>
                            <th scope="row" class="me-2 fw-semibold">
                                수술실
                            </th>
                            <td>
                                <select name="reservation_time" id="surgeryRoom" class="form-select custom-select">
                                    <optgroup label="수술실">
                                        <option value="1">수술실 1</option>
                                        <option value="2">수술실 2</option>
                                    </optgroup>
                                </select>
                            </td>
                         </tr>
                         <tr>
                         <td colspan="2">
		                <input type="button" value="등록" style="float:right;">
		                </td>
		                </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
			<div class="col-xl-7" style="margin:-5px">
				<div class="row">
					<div class="col-xl-12">
						<div class="card custom-card" style="height: 790px">
							<div class="card-header">
								<div class="card-title">일정 등록</div>
							</div>
							<div class="card-body">
								<div id="calendar"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- End::app-content -->
<!--본문 끝-->

<!-- Scroll To Top -->
<div class="scrollToTop">
	<span class="arrow"><i class="ri-arrow-up-s-fill fs-20"></i></span>
</div>
<script>
var calData;

	
	

$(function(){
	var calendarPersonal = '';
	console.log("dd")
// 	var calendarEl = $('#calendar');
	var calendarEl = document.querySelector("#calendar");
	console.log(calendar);
	
	function loadCalendar(data){
		console.log("BB")
		$.ajax({
			url :"/surgery/getSurgeryCal",
			type : "get",
		success : function(res){
				
			if(calData != null) {
				res = calData;
			}
			
		calendarPersonal = new FullCalendar.Calendar(calendarEl, {
// 		       events : [
// 		    	   {
// 					title : "하이",
// 					start : "2024-04-26"
// 		       }
// 		    	   ],
				
				events : res,	
		       initialView: 'dayGridMonth',
		       height : '680px',
		       headerToolbar : {				// 헤드툴바 설정
		           left: 'prev,next,today',
		           center: 'title',
		           right: ''
		       },
		        expandRows : true,
		        selectable : true, // 달력 일자 드래그 설정가능
				droppable : true,	// 드롭 가능 여부 설정
				editable : true,	// 수정 가능 여부 설정
				nowIndicator: true, // 현재 시간 마크
				navLinks : true,	// 링크 활성화 여부 설정
		    	locale: 'ko', // 한국어 설정
				
		    	
		    	// 날짜 선택
		    	dateClick : function(info){
		    		console.log(info);
		    	    var clickedDate = info.format('YYYY-MM-DD');
		    	    // 이벤트 데이터 가져오기
		    	    var events = getEventsForDate(clickedDate);
		    		console.log(events);
		    		let dateStr = date.dateStr;
		    		$.ajax({
		    			url:"/surgery/surgerydatecheck",
		    			type:"post",
		    			data : JSON.stringify({"startStr" : dateStr}),
		    			contentType : "application/json; charset=utf-8",
// 		    			data : startStr,
		    			success : function(res){
							if(res.length == 2){
								alert('비어있는 수술실 X')
								return;
							}
				    		$('#surgeryReservDate').val(dateStr);
		    			}
		    		});
		    		
		    	}
		    	
		    	
		    	
		    	
		    	
		    	
		    	
         });
		calendarPersonal.render();
			}
		})
	}
	loadCalendar();
	
	
	$(document).on("click",".surgeryMem",function(){
		console.log("ㅇㅇ");
		let data = $(this).data("data");
		
		$('#doctorName').text(data.doctorName);
		$('#patntName').text(data.patntName);
		$('#patntGender').text(data.patntGender);
		$('#patntAge').text(data.patntAge);
		$('#patntTel').text(data.patntTel);
		let surgeryName = data.surgeryKindName;
		let surgeryDoctor = data.surgeryDoctor;
		if(surgeryName.length > 16) {
			surgeryName = surgeryName.substr(0,16);
			$('#surgeryName').text(surgeryName+"...");
		}else{
			$('#surgeryName').text(data.surgeryKindName);
		}
		$('#bodypartName').text(data.bodycodeName);
		
		$.ajax({
			url : "/surgery/empvacationcal",
			type : "post",
			data : JSON.stringify({"empNo" : surgeryDoctor}),
			contentType : "application/json; charset=utf-8",
			success : function(data){
				calData = data;
				loadCalendar();
			}
		});
	});
});

</script>