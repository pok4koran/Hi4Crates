<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mapper.IMainAdminMapper">
	
	
	<!-- <insert id="enrollMember" parameterType="memberVO" >
		insert into member(
		mem_no, mem_id, mem_pw, mem_name, mem_age, mem_gender,mem_regno1, mem_regno2,
		mem_tel,mem_address1, mem_address2, mem_signup_date,mem_type,mem_social
		)
		values(
		member_seq.nextval, #{memRegno},#{memRegno1},#{memName},#{memAge},#{memGender},#{memRegno1},#{memRegno2},
		#{memTel},#{memAddress1},#{memAddress2},SYSDATE,'MT002','N'
		)
		
	</insert> -->
	
	<insert id="enrollMember" parameterType="memberVO" useGeneratedKeys="true" >
	    <!-- keyProperty에 설정된 프로퍼티에 자동 생성된 키가 할당됨 -->
	    <selectKey keyProperty="memNo" resultType="memberVO" order="BEFORE">
	        SELECT member_seq.nextval as mem_no FROM dual
	        <!-- 새로 삽입된 레코드의 키 값을 가져옴 -->
	    </selectKey>
	    <!-- useGeneratedKeys 속성을 true로 설정하여 자동 생성된 키를 가져옴 -->
	    <!-- keyProperty는 자동 생성된 키가 설정될 객체의 프로퍼티를 나타냄 -->
	    insert into member(
			mem_no, mem_id, mem_pw, mem_name, mem_age, mem_gender,mem_regno1, mem_regno2,
			mem_tel,mem_postcode,mem_address1, mem_address2, mem_signup_date,mem_type,mem_social
		)
		values(
			#{memNo}, #{memRegno},#{memRegno1},#{memName},#{memAge},#{memGender},#{memRegno1},#{memRegno2},
			#{memTel},#{memPostcode},#{memAddress1},#{memAddress2},SYSDATE,'MT002','N'
		)
		
	</insert>
	
	
	<insert id="enrollPatient" parameterType="memberVO" useGeneratedKeys="true" >
		<selectKey keyProperty="patntNo" resultType="memberVO" order="BEFORE">
			select patient_seq.nextval as patnt_no from dual
		</selectKey>
		
		insert into patient(
			patnt_no, mem_no
		)
		values(
			#{patntNo},#{memNo}
		)
	
	</insert>
	
	
	
	 <select id="findReceiptDoctor" resultType="memberVO">
		 SELECT mem_name, m.mem_no, e.emp_no, clinic_no, code_name
			FROM member m, emp e, clinic c, common_code
			WHERE m.mem_no = e.mem_no
			AND e.emp_no = c.emp_no
			AND code_no = clinic_no
			AND (clinic_status IN ('CS001', 'CS002') OR clinic_status IS NULL)
        
	</select> 
	
	<insert id="insertReceipt" parameterType="receiptVO" useGeneratedKeys="true" >
	     <selectKey keyProperty="receiptNo" resultType="receiptVO" order="BEFORE">
	            SELECT receipt_seq.nextval as receipt_no FROM dual
	            <!-- 새로 삽입된 레코드의 키 값을 가져옴 -->
	      </selectKey>
	    insert into receipt(
	        receipt_no, receipt_date, receipt_reason, receipt_status, 
	        patnt_no, clinic_no, emp_no
	    )values(
	        #{receiptNo}, SYSDATE, #{receiptReason}, 'RS001', 
	        #{patntNo}, #{clinicNo},#{empNo}
	    )
	</insert>
	
	<insert id="insertPreDiagnosis" parameterType="receiptVO">
		insert into pre_diagnosis(
	    PRE_DIAGNOSIS_NO, PRE_DIAGNOSIS_EXP, PRE_DIAGNOSIS_DISEASE, PRE_DIAGNOSIS_ALLERGY,
	    PRE_DIAGNOSIS_PREGNANCY, PRE_DIAGNOSIS_CHOICE, PRE_DIAGNOSIS_DATE, PATNT_NO
		)VALUES(
		    PRE_DIAGNOSIS_SEQ.NEXTVAL , #{preDiagnosisExp},#{preDiagnosisDisease},#{preDiagnosisAllergy},
		    #{preDiagnosisPregnancy},#{preDiagnosisChoice},SYSDATE,#{patntNo}
		)
	</insert>
	
	<insert id="insertHistory" parameterType="receiptVO">
	    INSERT INTO history (
	    	history_no, history_date, history_loc, history_status, receipt_no
	    ) VALUES (
	    	HISTORY_SEQ.NEXTVAL, SYSDATE, #{clinicNo},'HS001',#{receiptNo}
	    )  
	
	</insert>
	
	
	<insert id="insertEvaluation">
		insert into evaluation (
			evl_no, receipt_no
		) values (
			EVALUATION_SEQ.NEXTVAL,#{receiptNo}
		)
	
	</insert>
	
	
	<select id="getMedicineRequestList" resultType="medicineRequestVO">
		
		SELECT
		    mr.medicine_request_no, mr.mdcin_no, mdcin_name, medicine_request_quantity,medicine_request_unit, medicine_request_person, mem_name, medicine_request_date ,
            medicine_result_agree, c.code_name
		FROM
		    medicine_request mr , emp e , member m ,medicine me, MEDICINE_REQUEST_RESULT re, common_code c
		where mr.medicine_request_person = e.emp_no
		and m.mem_no = e.mem_no
		and mr.mdcin_no = me.mdcin_no
		and mr.MEDICINE_REQUEST_NO =re.MEDICINE_REQUEST_NO
		and c.code_no = re.medicine_result_agree
	</select>
	
	
	<select id="getTodayDoctors" resultType="memberVO">
		select emp_no, mem_name
	    from emp e, member m
	    where emp_status='ES001'
	    and e.mem_no = m.mem_no
	</select>
	
	
	<select id="getDoctorsReservList" parameterType="clinicReservationVO" resultType="clinicReservationVO">
		SELECT
	     reserv_no,reserv_date, reserv_time, reserv_memo, c.emp_no, m.mem_name emp_name , c.mem_no, pm.mem_name mem_name, p.patnt_no
	    FROM
	    clinic_reservation c, emp e, member m , member pm, patient p 
	    where reserv_date = #{reservDate}
	    and c.emp_no = #{empNo}
	    and c.emp_no = e.emp_no
	    and e.mem_no = m.mem_no
	    and c.mem_no = pm.mem_no
	    and c.mem_no = p.mem_no
	</select>
	
	
	<update id="mediRequestAdmit" parameterType="medicineRequestResultVO">
		UPDATE medicine_request_result
		    SET
		       medicine_result_agree ='AS002',
		       medicine_result_disagree='',
		       medicine_result_date= sysdate,
		       medicine_result_emp = #{empNo}
		WHERE
		    medicine_request_no= #{medicineRequestno}
	</update>
	
	
	<update id="mediRequestRefuse" parameterType="medicineRequestResultVO">
		UPDATE medicine_request_result
		    SET
		       medicine_result_agree ='AS003',
		       medicine_result_disagree= #{medicineResultdisagree},
		       medicine_result_date= sysdate,
		       medicine_result_emp = #{empNo}
		WHERE
		    medicine_request_no= #{medicineRequestno}
	</update>
	
	<select id="getEquipmentRequestList" resultType="repairRequestVO">
		select r.repair_no, repair_date, repair_person, e.eq_no, eq_name, eq_company, e.eq_loc, cc.code_name loc_name, eq_model, eq_status, c.code_name status_name,
		 rr.repair_result_agree,rc.code_name result_name,repair_person, mem_name repairPersonName
		    from EQUIP_REPAIR_REQUEST r, medical_equip e, common_code c, common_code cc, equip_repair_result rr, common_code rc, emp emp, member m
		    where r.eq_no = e.eq_no
		    and e.eq_status = c.code_no
		    and e.eq_loc = cc.code_no
		    and r.repair_no = rr.repair_no
		    and rr.repair_result_agree = rc.code_no
		    and r.repair_person = emp.emp_no
   			and m.mem_no = emp.mem_no
	</select>
	
	<update id="equipRepairAdmit" parameterType="repairResultVO" >
		UPDATE equip_repair_result
		    SET
		        Repair_Result_Agree = 'AS002',
		        Repair_Result_Date = SYSDATE,
		        Emp_No = #{empNo}
			WHERE
		    repair_no =#{repairNo}
	</update>
	
	
	
	<update id="changeEqStatus">
		update medical_equip
			set eq_status = 'IS004'
			where eq_no = (select m.eq_no
			from equip_repair_result p,equip_repair_request q, medical_equip m
			where p.repair_no = q.repair_no
			and q.eq_no = m.eq_no
			and q.repair_no = #{repairNo})
	</update>
	
	
	<update id="equipRepairRefuse">
		UPDATE equip_repair_result
	    SET
	        repair_result_agree = 'AS003',
	        repair_result_disagree = #{repairResultdisagree},
	        repair_result_date = SYSDATE,
	        emp_no = #{empNo}
			WHERE
	    	repair_no = #{repairNo}
	</update>
	
	<select id="getReserveList" resultType="memberVO">
		select distinct m.mem_no, mem_name, r.receipt_no, r.patnt_no,mem_age, mem_gender 
		 from member m, history h, receipt r, patient p
		 where h.receipt_no = r.receipt_no
		 and m.mem_no = p.mem_no
		 and r.patnt_no = p.patnt_no
		 and history_loc = 'LOC012'
		 and history_status='HS001'
	</select>
	
	<select id="getMulli" parameterType="int" resultType="int">
		SELECT COUNT(*) AS mulliCnt
			FROM "ORDER" o, chart c, receipt r, common_code cc
			WHERE o.chart_no = c.chart_no
			AND c.receipt_no = r.receipt_no
			AND o.order_code = cc.code_no
			AND c.receipt_no = #{receiptNo}
			AND (order_code = 'OD003' or order_code = 'OD008' or order_code = 'OD009')
	</select>
	
	
	
	
    
    
	
	
	
	
</mapper>