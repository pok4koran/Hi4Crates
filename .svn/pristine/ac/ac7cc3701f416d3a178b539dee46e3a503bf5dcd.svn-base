<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>

<style>
img {
	width: 50px;
	height: auto;
	float: left;
}

.brightness {
	-webkit-filter: brightness(0.50);
	filter: brightness(0.50);
}

.opacity {
	-webkit-filter: opacity(50%);
	filter: opacity(50%);
}
.btn-sm {
	width: 3.25em;
	font-size: 8px;
/* 	display: flex; */
	align-items:center;
/* 	justify-content: center; */
}
.btn-bed {
	align-items:center;
	text-align: center;
	margin: 4px 15px;
}
</style>
</head>

<body>




	<!-- 본문 시작 -->
	<!-- Start::app-content -->
	<div class="main-content app-content">
		<div class="container-fluid">

			<!-- Start::row-1 -->
			<div class="row">
<!-- 				<div class="col-xxl-2 col-xl-12"> -->
				<div class="col-xl-2">
					<div class="row">
<!-- 						<div class="col-xxl-12 col-xl-6"> -->
						<div class="col-xl-12">
							<div class="card custom-card">

								<div class="card-header">
									<div class="card-title">환자 목록</div>
								</div>

								<div class="card-body p-0" id="waitingList">
								</div>
								
								<div class="card-footer">
									<span class="card-title text-muted fs-11 mb-0">
										환자 검색 조건: <br>
										LOC008	물리치료실<br>
										LOC009	물리치료대기실<br>
										LOC012	수납대기실<br>
										HS001	대기중<br>
										HS003	치료중<br>
										OD003	온열치료	ORDER<br>
										OD008	초음파치료	ORDER<br>
										OD009	충격파치료	ORDER
									</span>
								</div>
							</div>
						</div>
					</div>
				</div>

<!-- 				<div class="col-xxl-10 col-xl-12"> -->
				<div class="col-xl-4">

					<div class="card custom-card" style="height: 37vh;">
						<div class="card-header">
							<div class="card-title">오더 조회</div>
						</div>
						
						<div class="card-body" data-simplebar style="overflow-y: auto;">
							<ul class="list-group list-group-flush">
								<li class="list-group-item" id="order1">
									환자이름(성별/나이)
								</li>
								<li class="list-group-item" id="order2">
									오더종류
								</li>
								<li class="list-group-item" id="order3">
									치료부위
								</li>
								<li class="list-group-item" id="order4">
									진료차트내용? chart_record
								</li>
							</ul>
						</div>
						
					</div>

					<div class="row-xl-3">
						<div class="card custom-card" style="height: 37vh;">
							<div class="card-header">
								<div class="card-title">치료세팅</div>
							</div>
							<div class="card-body" style="overflow-y: auto;">
								<div>
									<div>
	<!-- 									<p class="fw-semibold mb-3 d-flex align-items-center"> -->
									</div>
									<div>
										<p class="card-title fw-semibold">치료부위 </p>
										<div id="treatPart"></div>
									</div>
									<hr>
									<div>
										<p class="card-title fw-semibold">치료방법 </p>
										<div id="treat1"></div>
										<div id="treat2"></div>
										<div id="treat3"></div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="col-xl-6">
					<div class="row">
						<div class="col-xl-12">
							<div class="card custom-card">
								<div class="card-header d-flex justify-content-between">
									<div class="card-title">환자 배치</div>
								</div>
								<div class="card-body">
									<div class="table-responsive">
										<table class="table text-nowrap table-bordered">
											<tr>
												<td>
													<div id="bed1name"></div>
												</td>
												<td>
													<div id="bed2name"></div>
												</td>
												<td>
													<div id="bed3name"></div>
												</td>
											</tr>
											<tr>
												<td>
													<div class="container">
														<!-- <div style="position: relative;" onclick="countDown('bed1');"> -->
														<img id="bed1"
															src="/resources/assets/img/bedtime-icon.svg"
															class="brightness opacity">
<!-- 														<div style="position: absolute;"> -->
														<!-- </div> -->
													</div>
												</td>
												<td>
													<div class="container">
														<img id="bed2"
															src="/resources/assets/img/bedtime-icon.svg"
															class="brightness opacity">
														<!-- </div> -->
													</div>
												</td>
												<td>
													<div class="container">
														<img id="bed3"
															src="/resources/assets/img/bedtime-icon.svg"
															class="brightness opacity">
														<!-- </div> -->
													</div>
												</td>
											</tr>
											<tr>
												<td>
													<div id="bed1_1" style=";">
														<span style='color: #808080; font-size: large;'>00:00</span>
														
													</div>
												</td>
												<td>
													<div id="bed2_1">
														<span style='color: #808080; font-size: large;'>00:00</span>
													</div>
												</td>
												<td>
													<div id="bed3_1">
														<span style='color: #808080; font-size: large;'>00:00</span>
													</div>
												</td>
											</tr>
											<tr>
												<td>
													<div class="container">
														<img id="bed4"
															src="/resources/assets/img/bedtime-icon.svg"
															class="brightness opacity">
														<!-- </div> -->
													</div>
												</td>
												<td>
													<div class="container">
														<img id="bed5"
															src="/resources/assets/img/bedtime-icon.svg"
															class="brightness opacity">
														<!-- </div> -->
													</div>
												</td>
												<td>
													<div class="container">
														<div style="position: relative;"
															onclick="countDown('bed6');">
															<img id="bed6"
																src="/resources/assets/img/bedtime-icon.svg"
																class="brightness opacity">
														</div>
													</div>
												</td>
											</tr>
											<tr>
												<td>
													<div id="bed4_1">
														<span style='color: #808080; font-size: large;'>00:00</span>
													</div>
												</td>
												<td>
													<div id="bed5_1">
														<span style='color: #808080; font-size: large;'>00:00</span>
													</div>
												</td>
												<td>
													<div id="bed6_1">
														<span style='color: #808080; font-size: large;'>00:00</span>
													</div>
												</td>
											</tr>
										</table>
									</div>
								</div>
							</div>
						</div>

						<div class="col-xl-12">
							<div class="card custom-card">
								<div class="card-header d-flex justify-content-between">
									<div class="card-title">치료 기록</div>
								</div>
								<div class="card-body">
									<div id="reportInfo"></div>
									<div id="typeInfo"></div>
									<div id="selectArea">
										<select class="form-select">
											<option>치료기기</option>
											<option value="1" id="equip1">항목1</option>
											<option value="2" id="equip2">항목2</option>
											<option value="3" id="equip3">항목3</option>
										</select>
									</div>
									<div>
										<textarea class="form-control" id="" placeholder="치료 요약을 작성합니다."></textarea>
									</div>
								</div>
								<div class="card-footer">
									<button class="btn btn-info" id="finish">버튼</button>
								</div>
							</div>
						</div>
					</div>
				</div>

			</div>
			<!--End::row-1 -->





		</div>
	</div>
	<!-- End::app-content -->
	<!--본문 끝-->

</body>
<script type="text/javascript">
// 대기 환자 목록 조회
function getWaitingList(){
	$.ajax({
		url: '/emp/physical/patnts',
		type: 'POST',
		dataType: 'json', // 서버에서 응답으로 JSON을 사용하는 경우
		success: function(data) {
			// 서버에서 받은 데이터를 처리하여 HTML 업데이트
			console.log("function getWaitingList()");
			console.log("data!!! " + data);
				
			let html = '';
			let sites = [
				{value: 'LOC008', text: '물리치료실'},
				{value: 'LOC009', text: '물리치료 대기실'},
				{value: 'LOC012', text: '수납 대기실'},
			];
			let states = [
				{value: 'HS001', text: '대기중'},
				{value: 'HS003', text: '치료중'},
			];

			// 환자 목록 생성
			$.each(data, function(index, item) {
				console.log("orderList")
				console.log(item);
				console.log(item.orderList);
				
				
				// 공통 서식 시작
				// (width: 232px;)
				html += '<div class="card border custom-card" style="background-color:white; width: 88%; height: 110px;margin-left: 10px;margin-bottom: 10px; margin-top: 5px;">';
				html += 	'<div class="card-header" style="height: 30px; background-color: #f6feff !important">';
				html += 		'<span class="fw-semibold fs-13" style="position: absolute; left: 12px; ">';
				// 장소 표시
				$.each(sites, function(index, site) {
					if (item.historyLoc === site.value) {
						html += site.text;
					}
					console.log("item.historyLoc: " + item.historyLoc);
					console.log("site.value: " + site.value);
				});
				
				html += 		'</span>';
				html += 	'</div>';
				html += 	'<div class="card-body p-3" style="width: 240px;height: 110px;margin-left: 10px;margin-bottom: 10px;">';
				html += 		'<div class="d-flex justify-content-between align-items-start mb-3 flex-wrap" style="">';
				html += 			'<div class="d-inline-flex align-items-start position-relative">';
				html += 				'<a href="javascript:void(0)" id="waitingMem" data-memNo="'+item.memNo+'" class="stretched-link"></a>';
				html += 				'<div class="flex-grow-1">';
				html += 					'<span class="mb-0 d-block fs-15 fw-semibold pickPt">';
				html += 						item.memName;
				html += 					'</span>';
				html += 					'<span class="fs-13 text-muted">';
				html += 						item.memGender + ', ' + item.memAge + '세'
				html += 					'</span>';
				html += 				'</div>';
				html += 			'</div>';
				// 환자 상태 표시(대기중/치료중)
				$.each(states, function(index, state) {
					if(state.value === 'HS003'){
						html += 						'<span class="fs-10 badge rounded-pill bg-secondary">';
					}else{
						html += 						'<span class="fs-10 badge rounded-pill bg-light text-dark">';
					}
					if (item.historyStatus === state.value) {
						html += state.text;
					}
					html += 			'</span>';
// 					console.log("item.historyStatus: " + item.historyStatus);
// 					console.log("state.value: " + state.value);
					
				});
				html += 		'</div>';
				html += 		'<input type="hidden" value="' + item.receiptNo + '" />';
				html += 	'</div>';
				html += '</div>';
				// 공통 서식 끝
				
			});	// $.each 끝
			
			// HTML 업데이트
			$('#waitingList').html(html);
		},	// success 끝
		error: function(xhr, status, error) {
			console.error(xhr.responseText); // 에러 처리
		}
	});
}	// getWaitingList() function 끝
// 페이지 로드 후 처음 한 번 요청을 실행
getWaitingList();
// 비동기 요청 반복 실행
setInterval(getWaitingList, 50000);
//////////////////////////////////////////////////
// 환자 목록에서 환자 클릭
var memNo;
var memName;
var memGender;
var memAge;
var therapyType;
// 환자 클릭해서 오더 출력
$('body').on('click','#waitingMem',function(event){
	event.preventDefault();
	let memNo = $(this).attr('data-memNo');
	console.log("memNo: " + memNo);
	let data = {
		memNo : memNo
	}
	$.ajax({
		url : "/emp/physical/order",
		type : "post",
		contentType : "application/json",
		data : JSON.stringify(data),
		success : function (res) {
			console.log(res);
			
			// 오더 조회 구역
			let order1 = $('#order1');
			let order2 = $('#order2');
			let order3 = $('#order3');
			let order4 = $('#order4');
			// 치료세팅 구역
			let treatPart = $('#treatPart');
			let treat1 = $('#treat1');
			let treat2 = $('#treat2');
			let treat3 = $('#treat3');

			// 오더 조회에 뿌릴 html 코드 목록
			let html1 = "";
			let html2 = "";
			let html3 = "";
			let html4 = "";
			
			// 치료세팅에 뿌릴 html 코드 목록
			let htmlTreat = "";
			let htmlTreat1 = "";
			let htmlTreat2 = "";
			let htmlTreat3 = "";
			
			// 치료부위 값 담을 곳
			let bodyCodes = res.bodyCodes;

			// 값 세팅 시작
			memNo = res.memNo;
			memName = res.memName;
			memGender = res.memGender;
			memAge = res.memAge;
			
			html1 += memName + " (" + memGender + ", " + memAge + "세)";
// 			html1 += "<br/>";
			html2 += "오더코드: ";
			// 오더코드 추가하며 치료세팅의 치료장비/치료종류 출력하기
			// 복수 출력해야 했던가? 확인 필요
			html2 += res.orderVO.orderCode + " (";
			if(res.orderVO.orderCode === 'OD003'){
				html2 += "온열치료)";
				htmlTreat1 += "온열 치료";
				therapyType = "온열 치료";
			}else if(res.orderVO.orderCode === 'OD008'){
				html2 += "초음파치료)";
				htmlTreat2 += "초음파 치료";
				therapyType = "초음파 치료";
			}else{
				html2 += "충격파치료)";
				htmlTreat3 += "충격파 치료";
				therapyType = "충격파 치료";
			}
// 			html2 += "<br/>";
			
			html3 += "치료부위: "
			$.each(bodyCodes, function(index, idx) {
				html3 += idx.codeName;
				html3 += " ";
				// 여기에서 치료세팅의 치료부위 자리에도 값 넣기
				htmlTreat += idx.codeName;
			});
			html3 += "<br/>"; 
			
// 			html4 += "chartDate: " + res.chartVO.chartDate + "<br/>";
			html4 += "차트 기록: " + res.chartVO.chartRecord + "<br/>";
// 			html4 += "담당 의사(empNo in order): " + res.empVO.empNo + "<br/>"
			html4 += "담당 의사: " + res.docName + "<br/>"
			
			order1.html(html1);
			order2.html(html2);
			order3.html(html3);
			order4.html(html4);
			treatPart.html(htmlTreat);
			treat1.html(htmlTreat1);
			treat2.html(htmlTreat2);
			treat3.html(htmlTreat3);
		}
	});
});
//클릭 타이머 코드
var timer;
// $("#bed1").on("click",function() {
$("#bed1").on("click",function() {
	console.log("click 이벤트 인식 ");
	var image = $("#bed1");
	var isBrightness = image.hasClass("brightness");
	var isOpacity = image.hasClass("opacity");
	const bedded1 = document.getElementById('bed1_1');

	var time = 10;
	var min = "";
	var sec = "";
	// var isStopped = true;

	// 이미지 CSS로 상태 파악
	if (isBrightness && isOpacity) {
		console.log("class 존재 인식 ");
		clearInterval(timer); // 이미 진행 중인 카운트다운을 멈춤
		image.removeClass("brightness opacity");
		// bedded1.innerHTML = "<span style='color:blue;'>추가될 텍스트.</span>";

		// pt_status update 를 ajax로
		
// 		$.ajax({
// 		url : "/emp/physical/order",
// 		type : "post",
// 		contentType : "application/json",
// 		data : JSON.stringify(data),
// 		success : function (res) {
		
		
		// 타이머 구역
		var time = 3;	// 카운트다운 시간 설정
		timer = setInterval(function() {
			var min = parseInt(time / 60);
			var sec = time % 60;

			
			// document.getElementById("bed1_1").innerHTML = 
			bedded1.innerHTML =
// 				"<span style='color:#007AFF;font-size:large;text-shadow: -1px 0px white, 0px 1px white, 1px 0px white, 0px -1px white;'>" +

				"<div class='container'>" +
					"<div class='inline-block'>" +
						"<div>" +
							"<span style='font-size:large;'>" + min
								+ ":" + sec + "</span>" +
						"</div>" +
// 						"<div>" +
// 							"<button class='btn btn-light btn-sm' onclick='endTherapy()' id='bed1Done'>완료</button>" +
// 						"</div>" +
					"</div>" +
				"</div>";
			time--;

			if (time < 0) {
				clearInterval(timer);
				// 				document.getElementById("bed1_1").innerHTML = "0:0";
				image.addClass("brightness opacity");
				bedded1.innerHTML = 
						"<div class='container'>" +
							"<div class='inline-block'>" +
								"<div>" +
									"<span style='color:#808080;font-size:large;'>00:00</span>" +
								"</div>" +
// 								"<div>" +
// 									"<button class='btn btn-light btn-sm' onclick='endTherapy()' id='bed1Done'>완료</button>" +
// 								"</div>" +
							"</div>" +
						"</div>";
				let report =
						memName + " (" + memGender + ", " + memAge + ")";
				$('#reportInfo').html(report);
				
				let typeInfo = $('#typeInfo');
				typeInfo.html(therapyType);
				console.log('typeInfo: ' + therapyType);
				
				// selectbox html 담을 공간
				let selectArea = $('#selectArea');
				let selectHtml = "";
				// typeInfo 종류에 따라 각각 다른 selectbox 구현
				if(therapyType === '온열 치료'){
					// 온열치료 selectbox 자리
					console.log('온열치료 selectbox');
					selectHtml += '<select class="form-select">';
						selectHtml += '<option value="1">' + 온열1 + '</option>';
						selectHtml += '<option value="2">' + 온열2 + '</option>';
						selectHtml += '<option value="3">' + 온열3 + '</option>';
					selectHtml += '</select>';
					selectArea.html(selectHtml);
					
				}else if(therapyType === '초음파 치료'){
					console.log('초음파치료 selectbox');

					selectHtml += '<select class="form-select">';
						selectHtml += '<option value="1">' + 초음파1 + '</option>';
						selectHtml += '<option value="2">' + 초음파2 + '</option>';
						selectHtml += '<option value="3">' + 초음파3 + '</option>';
					selectHtml += '</select>';
					selectArea.html(selectHtml);
				}else{
					console.log('충격파치료 selectbox');

					selectHtml += '<select class="form-select">';
						selectHtml += '<option value="1">' + 충격파1 + '</option>';
						selectHtml += '<option value="2">' + 충격파2 + '</option>';
						selectHtml += '<option value="3">' + 충격파3 + '</option>';
					selectHtml += '</select>';
					selectArea.html(selectHtml);
				}
				
				// 타이머 종료시 ajax로 pt_status update
// 				$.ajax({
// 					url : "/emp/physical/statusDone",
// 					type : "post",
// 					contentType : "application/json",
// 					data : JSON.stringify(data),
// 					success : function (res) {
// 						console.log("타이머 종료 ajax: success " + res);
						
// 					}
// 				}
				
				// 타이머 종료시 ajax로 pt_status update 종료
			}
		}, 1000);	// setInterval 끝
		
		// 환자 정보 세팅
		let bedName1 = $('#bed1name');
		let htmlName1 = '';
		htmlName1 += memName;
		htmlName1 += " (" + memGender + ", " + memAge + ")";
		bedName1.html(htmlName1);

	} else {	// 이미지 CSS로 상태파악 끝
		// 한번 더 눌렀을 때
		console.log("class 없음");
		clearInterval(timer);
		image.addClass("brightness opacity");
		//	bedded1.innerHTML = "<span style='color:#808080;font-size:large;'>00:00</span>";
	}
});

// 마지막 버튼 클릭시
// $("#finish").on("click",function() {
// 	// 해당 환자 상태 변경
// 	// ajax로 memeNo 전송
// 	// textarea 내용도 전송
	
// }
</script>
</html>